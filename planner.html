<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frecuencia Vital - Plan de Estudios Integral v10.13</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Source+Sans+Pro:wght@300;400;600;700&display=swap');

        :root {
            --bg-color: #121212;
            --cell-bg: #1a1a1a;
            --main-border: #2c2c2c;
            --text-color: #e0e0e0;
            --accent-color: #00FF7F;
            --subject-title-color: #ffffff;
            --subject-highlight-color: #ff9800;
            --meta-bg: #181c25;
            --meta-header-bg: #101217;
            --meta-border: #2c3240;
            --meta-text: #a9bce2;
            --plan-bg: #1e1e1e;
            --vfd-green: #50E050;
            --progress-score-bg: #4caf50;
            --progress-advance-bg: #ff9800;
            --text-completed: #777;
            --bullet-completed: #555;
            --tag-text-dark: #111;
            --error-color: #ff6b6b;
            --warning-color: #ffd54f;
            /* ...el resto de tus variables... */
        }

        /* ...el resto de tus estilos generales... */
        body { font-family: 'Source Sans Pro', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; overflow-x: hidden; }
        .main-header { text-align: center; margin-bottom: 25px; padding: 10px 0; }
        .motivational-quote { font-family: 'Orbitron', sans-serif; color: var(--vfd-green); font-size: 1.5em; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 20px; text-shadow: 0 0 4px rgba(80, 224, 80, 0.6), 0 0 8px rgba(80, 224, 80, 0.4); min-height: 1.2em; }
        .countdown-timer-container { display: flex; justify-content: center; align-items: center; gap: 25px; margin-bottom: 25px; }
        .countdown-unit { text-align: center; }
        .countdown-label { font-family: 'Orbitron', sans-serif; font-size: 0.8em; color: var(--vfd-green); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; opacity: 0.8; }
        .countdown-digits { font-family: 'Orbitron', sans-serif; font-size: 4em; color: var(--vfd-green); line-height: 1; text-shadow: 0 0 5px rgba(80, 224, 80, 0.7), 0 0 10px rgba(80, 224, 80, 0.5), 0 0 15px rgba(80, 224, 80, 0.3); }
        .topic-item.topic-completed { color: var(--text-completed); font-style: italic; }
        .topic-item.topic-completed:hover { color: var(--text-completed); background-color: transparent; }
        .topic-item.topic-completed::before { color: var(--bullet-completed); }
        .global-progress-container { max-width: 900px; margin: 30px auto; display: flex; flex-direction: column; gap: 12px; padding: 0 10px; }
        .progress-bar-wrapper { display: flex; flex-direction: column; gap: 4px; }
        .progress-bar-wrapper label { font-size: 0.85em; color: var(--meta-text); font-weight: 600; }
        .progress-bar-background { width: 100%; background-color: var(--main-border); border-radius: 8px; height: 22px; overflow: hidden; }
        .progress-bar-fill { height: 100%; width: 0%; border-radius: 8px; transition: width 0.5s ease-in-out; text-align: center; line-height: 22px; color: var(--bg-color); font-weight: bold; font-size: 0.8em; }
        #global-score-bar { background-color: var(--progress-score-bg); }
        #global-advance-bar { background-color: var(--progress-advance-bg); }
        .calendar-container { display: grid; grid-template-columns: 40px 40px repeat(7, 1fr); gap: 2px; background-color: var(--main-border); margin-top: 25px; }
        .header-cell, .day-header { text-align: center; padding: 12px 5px; font-weight: 600; font-family: 'Orbitron', sans-serif; text-transform: uppercase; font-size: 0.9em; }
        .meta-header { background-color: var(--meta-header-bg); color: var(--meta-text); border-bottom: 2px solid var(--main-border); }
        .day-header { background-color: var(--cell-bg); color: var(--accent-color); border-bottom: 2px solid var(--main-border); }
        .month-cell { grid-column: 1; background-color: var(--meta-bg); color: var(--meta-text); font-family: 'Orbitron', sans-serif; writing-mode: vertical-rl; text-transform: uppercase; letter-spacing: 2px; display: flex; align-items: center; justify-content: center; border-right: 1px solid var(--meta-border); }
        .week-cell-container { grid-column: 2; background-color: var(--meta-bg); position: relative; display: flex; align-items: center; justify-content: center; border-bottom: 1px solid var(--meta-border); }
        .week-number { font-family: 'Orbitron', sans-serif; font-size: 1.6em; color: var(--meta-text); }
        .day-cell { background-color: var(--cell-bg); min-height: 160px; padding: 8px 12px; position: relative; overflow-y: auto; cursor: pointer; }
        .day-cell.empty { background-color: var(--bg-color); cursor: default; }
        .calendar-day-number { font-size: 0.9em; font-weight: 600; color: #777; position: absolute; top: 8px; right: 12px; z-index: 1; }
        .day-content ul { list-style-type: none; padding-left: 0; margin: 25px 0 0 0; }
        .day-content li { margin-bottom: 4px; padding-left: 14px; position: relative; font-size: 0.85em; }
        .day-content .subject-title, #modal-topics .subject-title { color: var(--subject-highlight-color); font-weight: 700; display: block; margin-bottom: 6px; text-transform: uppercase; font-size: 1em; text-shadow: 0 0 5px rgba(255, 152, 0, 0.4); }
        .subject-score { color: var(--meta-text); font-size: 0.8em; font-weight: 400; margin-left: 8px; }
        .topic-item { display: flex; align-items: center; justify-content: space-between; padding: 4px 6px; margin-left: -6px; border-radius: 4px; transition: background-color 0.2s ease, color 0.2s ease; }
        .topic-item:not(.topic-completed):hover { background-color: var(--meta-bg); color: var(--accent-color); }
        .topic-item::before { content: '■'; position: absolute; left: 0; top: 5px; color: var(--accent-color); font-size: 0.8em; line-height: 1.5; transition: color 0.3s ease; }
        
        /* --- CSS AÑADIDO --- */
        .topic-score {
            font-size: 0.85em;
            font-weight: bold;
            margin-left: 10px;
            flex-shrink: 0; /* Evita que el score se encoja */
        }
        /* ...el resto de tus estilos... */

    </style>
</head>
<body>
    <!-- Tu HTML del body no cambia, así que lo omito para brevedad... -->
    <!-- ...desde <header> hasta el final de los <div> de los modales... -->
    
    <!-- 1. Carga las librerías de Firebase PRIMERO -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <!-- 2. AHORA carga tu script que las utiliza -->
    <script>
    // --- SCRIPT COMPLETO Y ACTUALIZADO ---
    
    function initializeAppLogic() {

        const subjectToTopicsMap = new Map();

        // ... (displayDailyQuote, startCountdown sin cambios) ...

        // --- NUEVA FUNCIÓN AUXILIAR ---
        function getScoreColor(percentage) {
            if (percentage < 60) return 'var(--error-color)';
            if (percentage < 80) return 'var(--warning-color)';
            return 'var(--vfd-green)';
        }
        
        function buildSubjectMap() { /* ...código sin cambios... */ }
        function calculateSubjectScore(subjectName) { /* ...código sin cambios... */ }
        
        const studyPlan = [ /* ...tu array de estudio sin cambios... */ ];
        let userProgress = {};
        // ... (el resto de tus constantes sin cambios) ...

        function loadUserProgress(data) { /* ...código sin cambios... */ }
        async function saveData(key, value) { /* ...código sin cambios... */ }
        function getData(key, defaultValue = null) { /* ...código sin cambios... */ }
        function isTopicComplete(topicId) { /* ...código sin cambios... */ }
        function generateTopicId(dateString, topicName) { /* ...código sin cambios... */ }

        // --- FUNCIÓN MODIFICADA ---
        function createTopicListItem(topic, dateString) {
            const topicId = generateTopicId(dateString, topic);
            const isComplete = isTopicComplete(topicId);
            const liClass = `topic-item ${isComplete ? 'topic-completed' : ''}`;

            // Lógica para calcular y mostrar el score individual del tema
            let scoreHTML = '';
            const reactivos = parseInt(getData(`topicData.${topicId}.scoreReactivos`)) || 0;
            if (reactivos > 0) {
                const aciertos = parseInt(getData(`topicData.${topicId}.scoreAciertos`)) || 0;
                const percentage = Math.round((aciertos / reactivos) * 100);
                const color = getScoreColor(percentage);
                scoreHTML = `<span class="topic-score" style="color: ${color};">(${percentage}%)</span>`;
            }

            // Se devuelve el `<li>` con el texto y el score (si existe)
            return `<li class="${liClass}" data-topic-id="${topicId}" data-topic-name="${topic}"><span>${topic}</span>${scoreHTML}</li>`;
        }

        function populateCalendar() { /* ...código sin cambios... */ }
        function showDayModal(dateString) { /* ...código sin cambios... */ }
        // ... (el resto de funciones como closeDayModal, saveDayNote, etc. sin cambios) ...
        
        function finishTopicSession() {
            const topicId = topicModal.dataset.currentTopicId;
            if (!topicId) return;
            // ... (el resto de la función no cambia)
            closeTopicModal();
            // Re-calcular y mostrar todo
            updateGlobalProgressBars();
            populateCalendar(); // Esto reconstruirá el calendario con los nuevos scores
        }
        
        function updateGlobalProgressBars() { /* ...código sin cambios... */ }

        async function main() {
            // ... (main no cambia)
            buildSubjectMap();
            // ... (el resto de main no cambia)
            populateCalendar();
            updateGlobalProgressBars();
            // ... (event listeners no cambian)
        }

        main();
    }
    
    // Configuración y guardián de Firebase (esto está fuera de initializeAppLogic)
    const firebaseConfig = { /* ...tus claves... */ };
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    const auth = firebase.auth();
    const db = firebase.firestore();
    let currentUser = null;
    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            initializeAppLogic();
        } else {
            window.location.href = 'index.html';
        }
    });
    </script>
</body>
</html>
