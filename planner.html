<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frecuencia Vital - Plan de Estudios Integral</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Source+Sans+Pro:wght@300;400;600;700&display=swap');
        :root { --bg-main: #121212; --bg-board: #1E1E1E; --bg-card: #2D2D2D; --bg-card-hover: #3a3a3a; --text-primary: #E0E0E0; --text-secondary: #a0a0a0; --border-color: #444; --shadow-color: rgba(0, 0, 0, 0.4); --accent-color: #00FF7F; --vfd-green: #50E050; --color-progress-completion: #3b82f6; --color-progress-low: #ef4444; --color-progress-medium: #f59e0b; --color-progress-high: #22c55e; --color-1: #00A9FF; --color-2: #FFA500; --color-3: #32C8CD; --color-4: #A855F7; --color-5: #E11D48; --color-6: #16A34A; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-main); color: var(--text-primary); line-height: 1.6; }
        .app-header { padding: 15px 40px; background-color: var(--bg-board); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; gap: 20px; }
        .app-header h1 { font-family: 'Orbitron', sans-serif; font-size: 1.8rem; color: var(--text-primary); margin: 0; flex-grow: 1; }
        .view-switcher-btn { background-color: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; transition: background-color 0.2s, color 0.2s; }
        .view-switcher-btn:hover { background-color: var(--bg-card-hover); }
        .view-switcher-btn .fas { margin-right: 8px; }
        .view-container { display: none; }
        .view-container.active { display: block; }
        #kanban-view { height: calc(100vh - 80px); }
        .global-progress-wrapper { width: 40%; max-width: 500px; display: flex; flex-direction: column; gap: 8px; }
        .global-progress-section { display: flex; align-items: center; gap: 10px; }
        .global-progress-section small { font-size: 0.7rem; color: var(--text-secondary); width: 80px; }
        .global-progress-container { flex-grow: 1; background-color: #333; border-radius: 8px; height: 12px; overflow: hidden; }
        .global-progress-bar { height: 100%; width: 0%; border-radius: 8px; transition: width 0.4s ease, background-color 0.4s ease; }
        .global-progress-bar.low { background-color: var(--color-progress-low); }
        .global-progress-bar.medium { background-color: var(--color-progress-medium); }
        .global-progress-bar.high { background-color: var(--color-progress-high); }
        #global-progress-bar-calendar, #global-progress-bar { background-color: var(--color-progress-completion); }
        .global-progress-text { font-size: 0.8rem; font-weight: bold; color: var(--text-secondary); width: 60px; text-align: right; }
        .calendar-header { text-align: center; padding: 20px; }
        .motivational-quote { font-family: 'Orbitron', sans-serif; color: var(--vfd-green); font-size: 1.5em; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 20px; text-shadow: 0 0 4px rgba(80, 224, 80, 0.6), 0 0 8px rgba(80, 224, 80, 0.4); min-height: 1.2em; }
        .countdown-container { position: relative; display: inline-block; }
        .countdown-timer-container { display: flex; justify-content: center; align-items: center; gap: 25px; margin-bottom: 25px; }
        .countdown-unit { text-align: center; }
        .countdown-label { font-family: 'Orbitron', sans-serif; font-size: 0.8em; color: var(--vfd-green); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; opacity: 0.8; }
        .countdown-digits { font-family: 'Orbitron', sans-serif; font-size: 4em; color: var(--vfd-green); line-height: 1; text-shadow: 0 0 5px rgba(80, 224, 80, 0.7), 0 0 10px rgba(80, 224, 80, 0.5), 0 0 15px rgba(80, 224, 80, 0.3); }
        #edit-countdown-btn { position: absolute; top: -5px; right: -30px; background: none; border: none; color: var(--text-secondary); font-size: 1.2em; cursor: pointer; transition: color 0.2s; }
        #edit-countdown-btn:hover { color: var(--accent-color); }
        #countdown-editor { display: none; margin-top: -15px; margin-bottom: 20px; align-items: center; justify-content: center; gap: 10px; }
        #countdown-date-picker { background-color: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-primary); padding: 5px; border-radius: 4px; font-family: 'Source Sans Pro', sans-serif; }
        #countdown-date-picker::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
        #save-countdown-btn { background-color: var(--accent-color); color: var(--bg-main); border: none; padding: 6px 12px; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .calendar-board { padding: 0 20px 20px; }
        .calendar-container { display: grid; grid-template-columns: 40px 40px repeat(7, 1fr); gap: 2px; background-color: var(--border-color); }
        .header-cell, .day-header { text-align: center; padding: 12px 5px; font-weight: 600; font-family: 'Orbitron', sans-serif; text-transform: uppercase; font-size: 0.9em; background-color: var(--bg-board); }
        .meta-header { background-color: #101217; color: #a9bce2; border-bottom: 2px solid var(--border-color); }
        .day-header { color: var(--accent-color); border-bottom: 2px solid var(--border-color); }
        .month-cell { grid-column: 1; background-color: #101217; color: #a9bce2; font-family: 'Orbitron', sans-serif; writing-mode: vertical-rl; text-transform: uppercase; letter-spacing: 2px; display: flex; align-items: center; justify-content: center; border-right: 1px solid #2c3240; }
        .week-cell-container { grid-column: 2; background-color: #101217; position: relative; display: flex; align-items: center; justify-content: center; border-bottom: 1px solid #2c3240; }
        .week-number { font-family: 'Orbitron', sans-serif; font-size: 1.6em; color: #a9bce2; }
        .day-cell { background-color: var(--bg-card); min-height: 160px; padding: 8px 12px; position: relative; overflow-y: auto; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
        .day-cell.empty { background-color: var(--bg-board); cursor: default; }
        .day-cell.drag-over { background-color: var(--bg-card-hover); border-color: var(--accent-color); }
        .day-cell.target-date { border-color: var(--color-progress-low); box-shadow: 0 0 10px rgba(239, 68, 68, 0.4); }
        .day-cell.target-date .calendar-day-number { color: var(--color-progress-low); font-weight: bold; }
        .day-cell.day-before-target { border-color: var(--color-progress-medium); }
        .day-cell.day-before-target .calendar-day-number { color: var(--color-progress-medium); }
        .calendar-day-number { font-size: 0.9em; font-weight: 600; color: #777; position: absolute; top: 8px; right: 12px; z-index: 1; transition: color 0.2s; }
        .day-content ul { list-style-type: none; padding-left: 0; margin: 25px 0 0 0; }
        .day-content li { margin-bottom: 4px; padding-left: 14px; position: relative; font-size: 0.85em; }
        .day-content .subject-title, #modal-topics .subject-title { color: #ff9800; font-weight: 700; display: block; margin-bottom: 6px; text-transform: uppercase; font-size: 1em; text-shadow: 0 0 5px rgba(255, 152, 0, 0.4); padding-left: 0; }
        .subject-title::before { content: none !important; }
        .subject-score { color: #a9bce2; font-size: 0.8em; font-weight: 400; margin-left: 8px; }
        .topic-item { display: flex; align-items: center; justify-content: space-between; padding: 4px 6px; margin-left: -6px; border-radius: 4px; transition: background-color 0.2s ease, color 0.2s ease, opacity 0.2s, border-top 0.1s, border-bottom 0.1s; border-top: 2px solid transparent; border-bottom: 2px solid transparent; }
        .topic-item[draggable="true"] { cursor: grab; }
        .topic-item.dragging { opacity: 0.5; }
        .topic-item:not(.topic-completed):not(.dragging):hover { background-color: var(--bg-card-hover); color: var(--accent-color); }
        .topic-item.drag-over-top { border-top-color: var(--accent-color); }
        .topic-item.drag-over-bottom { border-bottom-color: var(--accent-color); }
        .topic-item::before { content: '■'; position: absolute; left: 0; top: 5px; color: var(--accent-color); font-size: 0.8em; line-height: 1.5; transition: color 0.3s ease; }
        .topic-score { font-size: 0.85em; font-weight: bold; margin-left: 10px; flex-shrink: 0; }
        .kanban-board-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; padding: 20px; height: 100%; }
        .kanban-column { background-color: var(--bg-board); border-radius: 12px; display: flex; flex-direction: column; max-height: 100%; border-top: 3px solid var(--border-color); transition: border-top-color 0.4s ease; }
        .kanban-column.inprogress { border-top-color: var(--color-progress-completion); }
        .kanban-column.done { border-top-color: var(--color-progress-high); }
        .kanban-column-header { padding: 15px 20px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 10px; position: sticky; top: 0; background-color: var(--bg-board); z-index: 10; }
        .kanban-column-header h2 { font-size: 1.1rem; font-weight: 600; }
        .cards-container { flex-grow: 1; padding: 10px 20px 20px 20px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--border-color) var(--bg-board); }
        .specialty-header { display: flex; justify-content: space-between; align-items: center; margin: 20px 0 10px; padding-bottom: 8px; border-bottom: 1px solid var(--border-color); }
        .specialty-header h3 { font-size: 1rem; font-weight: 700; margin: 0; }
        .specialty-progress-bars-container { display: flex; flex-direction: column; gap: 4px; }
        .specialty-progress-wrapper { display: flex; align-items: center; gap: 8px; }
        .specialty-progress-container { width: 80px; height: 8px; background-color: #444; border-radius: 4px; }
        .specialty-progress-bar { height: 100%; width: 0%; border-radius: 4px; transition: width 0.3s ease; background-color: var(--color-progress-completion); }
        .specialty-score-progress-bar { height: 100%; width: 0%; border-radius: 4px; transition: width 0.3s ease; }
        .specialty-progress-text, .specialty-score-text { font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); width: 50px; text-align: right; }
        .kanban-card { background-color: var(--bg-card); border-radius: 8px; margin-bottom: 10px; box-shadow: 0 2px 8px var(--shadow-color); overflow: hidden; }
        .card-summary { padding: 12px 15px; cursor: pointer; }
        .card-summary-content { display: flex; justify-content: space-between; align-items: center; }
        .card-topic-name { font-weight: 600; flex-grow: 1; }
        .card-progress-wrapper { display: none; align-items: center; gap: 8px; flex-shrink: 0; }
        .kanban-card.has-progress .card-progress-wrapper { display: flex; }
        .card-progress-container { width: 80px; height: 8px; background-color: #444; border-radius: 4px; }
        .card-progress-bar { height: 100%; width: 0%; border-radius: 4px; transition: width 0.3s ease; }
        #col-inprogress-container .card-progress-bar { background-color: var(--color-progress-completion); }
        #col-done-container .card-progress-bar { background-color: var(--color-progress-high); }
        .card-progress-text { font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); width: 50px; text-align: right; }
        .card-details { max-height: 0; overflow: hidden; transition: max-height 0.5s cubic-bezier(0.25, 0.1, 0.25, 1.0); padding: 0 15px; }
        .kanban-card.is-open .card-details { max-height: 1000px; padding: 0 15px 15px; }
        .task-section { padding: 12px 0 12px 15px; border-left: 3px solid; margin: 15px 0; background-color: rgba(0,0,0,0.1); border-radius: 0 6px 6px 0; }
        .task-section h3 { font-size: 0.9rem; font-weight: 700; margin-bottom: 10px; }
        .task-section[data-section="1"]{border-color:var(--color-1)}.task-section[data-section="2"]{border-color:var(--color-2)}.task-section[data-section="3"]{border-color:var(--color-3)}.task-section[data-section="4"]{border-color:var(--color-4)}.task-section[data-section="5"]{border-color:var(--color-5)}.task-section[data-section="6"]{border-color:var(--color-6)}
        .task-item { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; font-size: 0.95rem; }
        .score-section { margin-top: 15px; padding-top: 10px; border-top: 1px dashed var(--border-color); }
        .score-inputs { display: flex; gap: 8px; align-items: center; }
        .score-inputs input, .score-percentage { width: 60px; background-color: var(--bg-main); border: 1px solid var(--border-color); color: var(--text-primary); padding: 5px; border-radius: 4px; text-align: center; font-size: 0.9rem; }
        .score-percentage { font-weight: bold; color: var(--color-progress-medium); display: inline-block; line-height: 1.5; }
        .tag { font-size: 0.7rem; font-weight: 600; padding: 2px 8px; background-color: var(--bg-card); color: var(--text-primary); border-radius: 10px; border: 1px solid var(--border-color); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); z-index: 998; display: none; opacity: 0; transition: opacity 0.3s ease; }
        .modal-overlay.visible { display: block; opacity: 1; }
        .modal-container { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 5px 25px rgba(0,0,0,0.5); z-index: 1000; width: 90%; max-height: 90vh; display: none; flex-direction: column; transition: transform 0.3s ease, opacity 0.3s ease; }
        .modal-container.visible { display: flex; }
        .modal-header { padding: 15px 25px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-family: 'Orbitron', sans-serif; font-size: 1.5em; }
        .modal-close { font-size: 2em; color: #888; cursor: pointer; line-height: 1; transition: color 0.2s; }
        .modal-close:hover { color: var(--text-primary); }
        .modal-content { padding: 25px; overflow-y: auto; }
        #details-modal { max-width: 650px; z-index: 1000; }
        #details-modal .modal-header h2 { color: var(--accent-color); }
        #modal-notes { width: 100%; box-sizing: border-box; min-height: 120px; background-color: #333; border: 1px solid var(--border-color); color: var(--text-primary); padding: 10px; resize: vertical; border-radius: 4px; }
        #modal-save-btn { width: 100%; padding: 12px; margin-top: 10px; background-color: var(--accent-color); color: var(--bg-main); border: none; cursor: pointer; font-family: 'Orbitron', sans-serif; font-size: 1em; border-radius: 4px; transition: background-color 0.2s, transform 0.1s; }
        #modal-save-btn:hover { background-color: #39ff94; }
        #modal-save-btn:active { transform: scale(0.98); }
        #topic-plan-modal { max-width: 900px; z-index: 1001; background-color: var(--bg-board); }
        #topic-plan-modal .modal-header h2 { color: var(--vfd-green); font-size: 1.3em; }
        #topic-plan-modal .modal-content { padding: 15px 25px; }
        
        @media (max-width: 768px) { .app-header { flex-direction: column; align-items: flex-start; gap: 15px; } .kanban-board-container { grid-template-columns: 1fr; } #kanban-view { height: auto; } .motivational-quote { font-size: 1.2em; } .countdown-digits { font-size: 3em; } .countdown-timer-container { gap: 15px; } .day-cell { min-height: 120px; } }
        @media (max-width: 600px) { .motivational-quote { font-size: 1em; letter-spacing: 1px; } .countdown-digits { font-size: 2.2em; } .countdown-label { font-size: 0.6em; } .countdown-timer-container { gap: 10px; } body { padding: 10px; } .calendar-container { grid-template-columns: 30px 30px repeat(7, 1fr); } .modal-content { padding: 15px; } #edit-countdown-btn { right: -5px; top: -15px; } }
    </style>
</head>
<body>
    <header class="app-header">
        <h1>FRECUENCIA VITAL</h1>
        <div class="global-progress-wrapper" id="global-progress-header">
             <div class="global-progress-section"><small>Progreso Total</small><div class="global-progress-container"><div class="global-progress-bar" id="global-progress-bar"></div></div><span class="global-progress-text" id="global-progress-text">0.00%</span></div>
             <div class="global-progress-section"><small>Promedio Vital</small><div class="global-progress-container"><div class="global-progress-bar" id="promedio-vital-bar"></div></div><span class="global-progress-text" id="promedio-vital-text">0.00%</span></div>
        </div>
        <button id="view-switcher" class="view-switcher-btn"><i class="fas fa-columns"></i> Ver Tablero Vital</button>
    </header>

    <div id="calendar-view" class="view-container active">
        <div class="calendar-header">
            <div id="motivational-quote-container" class="motivational-quote"></div>
            <div class="countdown-container">
                <div class="countdown-timer-container">
                    <div class="countdown-unit"> <div class="countdown-label">Days</div> <div class="countdown-digits" id="countdown-days">000</div> </div>
                    <div class="countdown-unit"> <div class="countdown-label">Hours</div> <div class="countdown-digits" id="countdown-hours">00</div> </div>
                    <div class="countdown-unit"> <div class="countdown-label">Minutes</div> <div class="countdown-digits" id="countdown-minutes">00</div> </div>
                    <div class="countdown-unit"> <div class="countdown-label">Seconds</div> <div class="countdown-digits" id="countdown-seconds">00</div> </div>
                </div>
                <button id="edit-countdown-btn" title="Editar fecha final"><i class="fas fa-calendar-alt"></i></button>
            </div>
            <div id="countdown-editor">
                <input type="date" id="countdown-date-picker">
                <button id="save-countdown-btn">Guardar</button>
            </div>
        </div>
        <main class="calendar-board">
            <div class="calendar-container" id="calendar-container"></div>
        </main>
    </div>

    <div id="kanban-view" class="view-container">
        <main class="kanban-board-container">
            <section class="kanban-column todo"><div class="kanban-column-header"><h2>Sin Empezar</h2></div><div class="cards-container" id="col-todo-container"></div></section>
            <section class="kanban-column inprogress"><div class="kanban-column-header"><h2>En Curso</h2></div><div class="cards-container" id="col-inprogress-container"></div></section>
            <section class="kanban-column done"><div class="kanban-column-header"><h2>Listo</h2></div><div class="cards-container" id="col-done-container"></div></section>
        </main>
    </div>

    <div class="modal-overlay" id="modal-overlay"></div>
    <div class="modal-container" id="details-modal">
        <div class="modal-header"> <h2 id="modal-title"></h2> <span class="modal-close" id="modal-close-day">×</span> </div>
        <div class="modal-content"> <div id="modal-topics"></div> <div class="notes-section" style="margin-top: 20px;"> <h3>Mis Anotaciones del Día</h3> <textarea id="modal-notes" placeholder="Escribe aquí tus notas generales para este día..."></textarea> <button id="modal-save-btn">Guardar Nota</button> </div> </div>
    </div>
    <div class="modal-overlay" id="topic-plan-overlay"></div>
    <div class="modal-container" id="topic-plan-modal">
        <div class="modal-header"> <h2 id="topic-plan-title"></h2> <span class="modal-close" id="modal-close-topic">×</span> </div>
        <div class="modal-content">
            <div class="study-flow-diagram">
                <div class="step-card step-1"> <div class="step-icon-container"><i class="fas fa-binoculars"></i></div> <div class="step-content"> <h2 class="step-title"><span class="step-number">1</span>VISTA RÁPIDA</h2> <ul class="step-details"> <li><label><input type="checkbox" class="task-checkbox" id="task-1-1"><i class="fas fa-list-ul task-icon"></i><span class="task-text">Índice</span><span class="tag">MADERA</span></label></li> <li><label><input type="checkbox" class="task-checkbox" id="task-1-2"><i class="fas fa-download task-icon"></i><span class="task-text">Descargar guías</span></label></li> <li><label><input type="checkbox" class="task-checkbox" id="task-1-3"><i class="fas fa-brain task-icon"></i><span class="task-text">CREA resúmenes + casos con IA</span><span class="tag">IAGOOGLE</span></label></li> </ul> </div> </div>
                <div class="step-card step-2"> <div class="step-icon-container"><i class="fas fa-magic"></i></div> <div class="step-content"> <h2 class="step-title"><span class="step-number">2</span>CREAR</h2> <ul class="step-details"> <li><label><input type="checkbox" class="task-checkbox" id="task-2-1"><i class="fas fa-chalkboard-teacher task-icon"></i><span class="task-text">Presentación</span><span class="tag">Genspark</span></label></li> <li><label><input type="checkbox" class="task-checkbox" id="task-2-2"><i class="fas fa-microphone-alt task-icon"></i><span class="task-text">Podcast MP3</span><span class="tag">NOTEBOOKLM</span></label></li> </ul> </div> </div>
                <div class="step-card step-3"> <div class="step-icon-container"><i class="fas fa-book-reader"></i></div> <div class="step-content"> <h2 class="step-title"><span class="step-number">3</span>LEER</h2> <ul class="step-details"> <li><label><input type="checkbox" class="task-checkbox" id="task-3-1"><i class="fas fa-file-alt task-icon"></i><span class="task-text">Leer Resumen</span></label></li> </ul> </div> </div>
                <div class="step-card step-4"> <div class="step-icon-container"><i class="fas fa-puzzle-piece"></i></div> <div class="step-content"> <h2 class="step-title"><span class="step-number">4</span>UNIFICAR</h2> <ul class="step-details"> <li><label><input type="checkbox" class="task-checkbox" id="task-4-1"><i class="fas fa-code task-icon"></i><span class="task-text">HTML</span><span class="tag">IAGOOGLE</span></label></li> </ul> </div> </div>
                <div class="step-card step-5"> <div class="step-icon-container"><i class="fas fa-tasks"></i></div> <div class="step-content"> <h2 class="step-title"><span class="step-number">5</span>PRACTICAR</h2> <div class="practice-step-layout"> <div class="practice-tasks-column"> <ul class="step-details"> <li><label><input type="checkbox" class="task-checkbox" id="task-5-1"><i class="fas fa-notes-medical task-icon"></i><span class="task-text">Realiza CASOS CLÍNICOS</span></label></li> <li><label><input type="checkbox" class="task-checkbox" id="task-5-2"><i class="fas fa-redo-alt task-icon"></i><span class="task-text">Repasar</span><span class="tag">GENSPARK</span><span class="tag">MADERAS</span></label></li> </ul> </div> <div class="practice-score-column"> <h3>PUNTUACIÓN</h3> <div class="score-inputs"> <label>Aciertos:</label><input type="number" class="score-aciertos" min="0"> <label>Reactivos:</label><input type="number" class="score-reactivos" min="0"> <label>%:</label><div class="score-percentage" data-score="0">0.00%</div></div> </div> </div> </div> </div>
                <div class="step-card step-6"> <div class="step-icon-container"><i class="fas fa-head-side-headphones"></i></div> <div class="step-content"> <h2 class="step-title"><span class="step-number">6</span>MEMORIZAR</h2> <ul class="step-details"> <li><label><input type="checkbox" class="task-checkbox" id="task-6-1"><i class="fas fa-headphones-alt task-icon"></i><span class="task-text">Escuchar MP3</span></label></li> </ul> </div> </div>
            </div>
            <div class="topic-modal-footer"> <button id="topic-finish-btn" class="topic-finish-btn">Terminar Tema</button> </div>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script>
    const firebaseConfig = {
        apiKey: "AIzaSyD4SjKhedm4ZWHed70_sjQgxPokjHvwvUc",
        authDomain: "frecuencia-vital.firebaseapp.com",
        projectId: "frecuencia-vital",
        storageBucket: "frecuencia-vital.appspot.com",
        messagingSenderId: "492064882273",
        appId: "1:492064882273:web:46ad9f9a66126bfdb53420",
        measurementId: "G-0C466YCX31"
    };
    
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.firestore();
    let currentUser = null;
    
    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            initializeAppLogic();
        } else {
            window.location.href = 'index.html';
        }
    });

    const medicalTopics = {
        "ENDOCRINOLOGÍA": ["Dislipidemias", "Hipertiroidismo", "Hipotiroidismo", "Cáncer de tiroides (Enfoque en Papilar)", "Nódulo tiroideo", "Obesidad en adultos", "Síndrome metabólico", "Enfermedad de Cushing / Síndrome de Cushing", "Enfermedad de Addison"],
        "UROLOGÍA": ["Escroto agudo y Torsión testicular", "Hiperplasia prostática benigna", "Cáncer de próstata", "Pielonefritis aguda", "Infección de tracto urinario", "Urolitiasis", "Cáncer testicular", "Disfunción eréctil"],
        "ORL": ["Faringoamigdalitis", "Epistaxis", "Rinosinusitis aguda", "Otitis externa aguda", "VPPB", "Mastoiditis aguda", "Parálisis de Bell"],
        "OFTALMOLOGÍA": ["Catarata", "Conjuntivitis", "Glaucoma de ángulo aberto", "Glaucoma de ángulo cerrado", "Ojo rojo", "Retinopatía diabética", "Trauma ocular", "Desprendimiento de retina"],
        "TYO": ["Osteoartritis", "Osteomielitis", "Fracturas expuestas", "Esguince cervical", "Lumbalgia", "Síndrome de hombro doloroso", "Luxación glenohumeral", "Fractura de clavícula", "Fractura de radio distal", "Fractura de cadera", "Lesiones de rodilla", "Esguince de tobillo", "Fractura de tobillo", "Osteosarcoma", "Sarcoma de Ewing", "Hernia de disco", "Túnel del carpo", "Epifisiolistesis femoral", "Legg-Calvé-Perthes", "Embolia grasa", "Tumores óseos malignos", "Costilla cervical", "Fractura de húmero proximal", "Luxación de codo", "Codo de niñera", "Fracturas de codo", "Fracturas de antebrazo", "Lesiones fisiarias", "Luxación coxofemoral", "Fractura de diáfisis de tibia", "Rotura de talón de Aquiles", "Pie equino varo", "Pie plano"],
        "CARDIOLOGÍA": ["Pericarditis", "Endocarditis infecciosa", "Estenosis aórtica", "Insuficiencia aórtica", "Estenosis mitral", "Insuficiencia mitral", "Fiebre reumática", "Hipertensión arterial sistémica", "Crisis hipertensivas", "Insuficiencia cardíaca aguda", "Insuficiencia cardíaca crónica", "Infarto agudo de miocardio", "Disección aórtica", "Cor pulmonar crónico", "Edema pulmonar", "Hipotensión ortostática", "Aneurisma aórtico abdominal", "Enfermedad coronaria", "Otras valvulopatías", "Hipertensión pulmonar", "Rehabilitación cardíaca"],
        "ANGIOLOGÍA": ["Enfermedad arterial periférica", "Insuficiencia venosa", "Pie diabético", "Tromboembolia pulmonar", "Trombosis venosa profunda", "Úlceras por presión", "Paget-Schroetter", "Tromboembolia venosa en obstetricia"],
        "ACLS": ["Soporte vital básico", "RCP", "Taquicardia ACLS", "Taquicardia supraventricular", "Bloqueos AV", "Bradicardia", "Fibrilación auricular", "Fibrilación ventricular", "Síndrome de WPW"],
        "ATLS": ["PLS (Posición Lateral de Seguridad)", "Ahogamiento", "Politrauma", "Tipos de shock", "Choque hipovolémico", "Quemaduras", "Gran quemado", "TCE adultos", "TCE pediátrico", "Trauma torácico", "Hemotórax", "Neumotórax a tensión", "Taponamiento cardiaco", "Trauma abdominal", "Shock neurogénico", "Neumotórax aberto", "Neumotórax simple", "Trauma espinal", "Catéter venoso central", "Hipotermia", "Fracturas de cráneo", "Lesión traqueobronquial", "Ruptura diafragmática", "Trauma esplénico", "Trauma obstétrico", "Trauma pélvico"],
        "TOXICOLOGÍA": ["Manejo de intoxicaciones", "Toxíndromes", "Intoxicación por benzodiacepinas", "Intoxicación por organofosforados", "Intoxicación por paracetamol", "Intoxicación por salicilatos", "Lactrodectus", "Loxosceles", "Mordedura de serpiente", "Picadura de alacrán", "Golpe de calor", "Intoxicación por etanol", "Intoxicación por monoxido de carbono", "Intoxicación por opiáceos", "Anafilaxia", "Ingesta de cáusticos", "Intoxicación alimentaria", "Intoxicación por alcoholes", "Intoxicación por anfetaminas", "Intoxicación por DMT", "Intoxicación por fentanilo", "Intoxicación por hidrocarburos", "Intoxicación por metales pesados", "Intoxicación por plomo", "Picadura de himenópteros"],
        "GASTROENTEROLOGÍA": ["Absceso hepático amebiano", "Cirrosis hepática", "Insuficiencia hepática", "Ascitis", "Encefalopatía hepática", "Hepatitis A", "Hepatitis B", "Hepatitis C", "Pancreatitis aguda", "Reflujo ERGE", "Enfermedad ácido péptica", "Síndrome de intestino irritable", "Sangrado TDA", "Sangrado TDB", "Várices esofágicas", "EHGNA", "Enfermedad de Crohn", "Colitis ulcerativa", "Cáncer gástrico", "Carcinoma hepatocelular", "Absceso hepático piógeno", "Hepatitis autoinmune", "Pancreatitis crónica", "Acalasia", "Esófago de Barret", "Dispepsia funcional", "Mallory Weiss", "Zollinger-Ellison", "Enfermedad celíaca", "Cáncer de esófago"],
        "CIRUGÍA ABDOMINAL Y COLOPROCTOLOGÍA": ["Cáncer de páncreas", "Apendicitis aguda", "Apendicitis en el embarazo", "Colecistitis aguda", "Coledocolitiasis", "Colelitiasis", "Colangitis aguda", "Hernias", "Hernia inguinal", "Oclusión intestinal", "Enfermedad hemorroidal", "Fístula anal", "Fisura anal", "Absceso anal", "Enfermedad diverticular", "Cáncer colorrectal", "Isquemia intestinal", "Vólvulo de sigmoides", "Heridas quirúrgicas", "Complicaciones post Qx", "Colangiocarcinoma", "Fístulas biliointestinales", "Hernia femoral", "Hernia hiatal", "Hernia umbilical", "Hernia ventral", "Vólvulo de ciego", "Quiste pilonidal", "Poliposis adenomatosa familiar (PAF)"],
        "CIRUGÍA PEDIÁTRICA": ["Atresia duodenal", "Atresia esofágica", "Criptorquidia", "Estenosis pilórica", "Hernia diafragmática congénita", "Invaginación intestinal", "Nefroblastoma", "Neuroblastoma", "Divertículo de Meckel", "Hirschsprung", "Atresia biliar", "Atresia de coanas", "Atresia yeyunoileal", "Espina bífida", "Malformaciones rectales", "Malrotación intestinal", "Patología umbilical"],
        "GINECOLOGÍA": ["Fitz-Hugh-Curtis", "Dismenorrea aguda", "Amenorreas primarias", "Amenorreas secundarias", "Sangrado uterino anormal", "Adenomiosis", "Anticonceptivos generalidades", "Anticonceptivos GPC", "Anticonceptivos hormonales combinados", "Anticoncepción de emergencia", "DIU de cobre", "DIU de levonorgestrel", "Implante subdérmico", "Progestágenos solos", "Lactancia como anticonceptivo", "Infertilidad", "Condón", "Vasectomía", "Cistocele e incontinencia", "Endometriosis", "Enfermedad pélvica inflamatoria", "Hidrosalpinx", "Hiperplasia endometrial", "Mastitis", "Mastopatía fibroquística", "Fibroadenoma", "Papiloma intraductal", "Patología mamaria benigna", "Quiste mamario", "Osteoporosis post menopausia", "Insuficiencia ovárica primaria", "Menopausia y climaterio", "Miomatosis uterina", "Oclusión tubaria bilateral OTB", "Ovario poliquístico", "Quiste de ovario benigno", "Torsión ovárica", "Vaginitis bacteriana", "Vaginitis infecciosa", "Trichomoniasis", "Bartolinitis", "Candidiasis vulvovaginal", "Chlamydia"],
        "ONCOGINE": ["Tamizaje cáncer de mama", "Cáncer de mama", "Cáncer cérvicouterino", "Cáncer de endometrio", "Cáncer de ovario", "Cáncer de vagina", "Tumores anexiales"],
        "OBSTETRICIA": ["Control prenatal", "Aloinmunización materna", "Estática fetal", "Tipos de pelvis", "Atención del parto", "Manejo activo del parto", "Cesárea", "Parto pretérmino", "Puerperio fisiológico", "Líquido amniótico", "Ruptura prematura de membranas", "Corioamnionitis", "Distocias", "Embarazo múltiple", "Endometritis puerperal", "Hiperémesis gravídica", "Insuficiencia cervical", "Muerte fetal", "Enfermedades hipertensivas del embarazo", "Preeclampsia sin datos de severidad", "Síndrome de HELLP", "Diabetes gestacional", "IVU en el embarazo", "Restricción del crecimiento intrauterino", "Sepsis puerperal", "Síndrome de Sheehan", "Depresión posparto"],
        "HEMORRAGIAS OBSTÉTRICAS": ["Generalidades de hemorragias", "Hemorragia postparto", "Desgarro perineal", "Amenaza de aborto", "Aborto espontáneo", "Acretismo placentario", "Atonía uterina", "Choque hemorrágico en obstetricia", "Desprendimiento prematuro de placenta normoinserta", "Embarazo ectópico", "Placenta previa", "Ruptura uterina", "Vasa previa", "Enfermedad trofoblástica gestacional"],
        "NEONATOLOGÍA": ["APGAR", "Apnea del prematuro", "Asfixia neonatal", "Displasia broncopulmonar", "Silverman Anderson", "Síndrome de aspiración de meconio", "Maduración pulmonar", "Síndrome de dificultad respiratoria", "Encefalopatía hipóxica", "Enfermedad hemorrágica del recién nacido", "Enterocolitis necrotizante", "Hipoacusia neonatal", "Hipoglucemia neonatal", "Hirschsprung", "Ictericia neonatal", "Muerte súbita del lactante", "Prematuro sano", "Reanimación neonatal", "Recién nacido de término", "Sepsis neonatal", "Tamiz neonatal", "Taquipnea transitoria del recién nacido", "Lesiones de plexo braquial obstétrico", "Lesiones extracraneales", "Displasia del desarrollo de la cadera DDC"],
        "CONGÉNITAS": ["Cardiopatías congénitas", "Tetralogía de Fallot", "Coartación aórtica", "Persistencia del conducto arterioso", "Fenilcetonuria", "Fibrosis quística", "Galactosemia clásica", "Storch", "Storch Citomegalovirus", "Storch herpes simple", "Storch rubéola congénita", "Storch sífilis congénita", "Storch toxoplasmosis", "Storch varicela congénita"],
        "ESCOLAR": ["Control de niño sano", "Etapas del crecimiento", "Talla baja", "Alergia alimentaria", "Cuerpo extraño", "Dermatitis del pañal", "Estreñimiento funcional", "Hiperplasia adrenal congénita", "Hipotiroidismo congénito", "Maltrato infantil", "Mucopolisacaridosis", "Reflujo gastroesofágico del lactante"],
        "NUTRICIÓN PEDIÁTRICA": ["Alimentación complementaria", "Deficiencia de vitamina A", "Desnutrición pediátrica", "Hipovitaminosis", "Intolerancia a la lactosa", "Lactancia materna", "Obesidad en escolares", "Pelagra en niños", "Raquitismo carencial", "Síndrome metabólico en niños"],
        "INFECTOLOGÍA PEDIÁTRICA": ["Adenitis mesentérica", "Onfalitis", "Exantemáticas Diferencial", "Eritema infeccioso", "Escarlatina", "Exantema súbito", "Enfermedad de Kawasaki", "Síndrome mano pie boca", "Rubéola", "Sarampión", "Varicela", "Parotiditis", "Bronquiolitis", "Epiglotitis", "Laringotraqueitis CRUP", "Mononucleosis infecciosa", "Tos ferina", "IVU en menores"],
        "VACUNAS": ["Vacunas generalidades", "Tipos de vacunas", "Vacunación universal", "Aplicación de vacunas", "Vacuna para personal de salud", "Vacunas en el embarazo", "Esquema de vacunación", "Bcg", "Hepatitis A", "Hepatitis B", "Hexavalente", "Influenza", "Neumocócica", "Rotavirus", "Sabin", "Salmonella", "Dpt", "Srp", "Tétanos", "Varicela", "Vph"]
    };

    async function initializeAppLogic() {
        // --- Declaraciones de variables y constantes ---
        const currentYear = new Date().getFullYear();
        const subjectToTopicsMap = new Map();
        const motivationalQuotes = [ "No te detengas hasta que te sientas orgulloso.", "El éxito es la suma de pequeños esfuerzos repetidos día tras día.", "Cree en ti mismo y todo será posible."];
        const ALL_TASK_IDS = ['task-1-1', 'task-1-2', 'task-1-3', 'task-2-1', 'task-2-2', 'task-3-1', 'task-4-1', 'task-5-1', 'task-5-2', 'task-6-1'];
        
        // ... (resto de las constantes y variables)
        let studyPlan; 
        let userProgress = {};
        let countdownTargetDateStr;
        let countdownInterval = null;
        
        const calendarView = document.getElementById('calendar-view');
        const kanbanView = document.getElementById('kanban-view');
        const viewSwitcherBtn = document.getElementById('view-switcher');
        const calendarContainer = document.getElementById('calendar-container');
        const dayModal = document.getElementById('details-modal'), dayModalOverlay = document.getElementById('modal-overlay'), dayModalTitle = document.getElementById('modal-title'), dayModalTopicsContainer = document.getElementById('modal-topics'), dayModalNotes = document.getElementById('modal-notes'), saveNoteButton = document.getElementById('modal-save-btn');
        const topicModal = document.getElementById('topic-plan-modal'), topicModalOverlay = document.getElementById('topic-plan-overlay'), topicModalTitle = document.getElementById('topic-plan-title'), topicStepCards = topicModal.querySelectorAll('.step-card'), topicTaskCheckboxes = topicModal.querySelectorAll('.task-checkbox'), aciertosInput = topicModal.querySelector('.score-aciertos'), reactivosInput = topicModal.querySelector('.score-reactivos'), percentageOutput = topicModal.querySelector('.score-percentage'), finishTopicButton = document.getElementById('topic-finish-btn');
        const editCountdownBtn = document.getElementById('edit-countdown-btn');
        const countdownEditor = document.getElementById('countdown-editor');
        const countdownDatePicker = document.getElementById('countdown-date-picker');
        const saveCountdownBtn = document.getElementById('save-countdown-btn');
        const quoteContainer = document.getElementById('motivational-quote-container');

        // --- Cuerpo Principal de la Aplicación ---
        async function main() {
            const docRef = db.collection('userProgress').doc(currentUser.uid);
            const doc = await docRef.get();
            loadUserProgress(doc.data());
            
            studyPlan = getData('studyPlan');
            if (!studyPlan || !studyPlan.length || new Date(studyPlan[0].date).getFullYear() !== currentYear) {
                studyPlan = createDefaultPlan();
                await saveData('studyPlan', studyPlan);
            }
            countdownTargetDateStr = getData('countdownTarget') || studyPlan[studyPlan.length - 1].date;
            countdownDatePicker.value = countdownTargetDateStr;

            setupAllEventListeners();
            displayDailyQuote();
            startCountdown();
            populateCalendar();
            // La vista Kanban se poblará al cambiar a ella por primera vez
        }

        function createDefaultPlan() {
            // Lógica para crear el plan por defecto, similar a la anterior
            let plan = [
                { date: `${currentYear}-06-19`, blocks: [{ subject: "ENDOCRINOLOGÍA", topics: ["Dislipidemias", "Hipertiroidismo", "Hipotiroidismo", "Cáncer de tiroides (Enfoque en Papilar)"] }] },
                // ... (resto del plan)
                { date: `${currentYear}-09-23`, blocks: [{ subject: "SIMULACIÓN FINAL", topics: ["Realizar simulación de examen completo", "Revisión de áreas débiles", "Planificación post-examen"] }] }
            ];
            // Enriquecer con el estado inicial del Kanban
            plan.forEach(day => day.blocks.forEach(block => block.topics.forEach(topic => {
                const topicId = generateTopicId(topic);
                if (!getData(`topicStates.${topicId}`)) {
                    saveData(`topicStates.${topicId}`, 'todo');
                }
            })));
            return plan;
        }
        
        // --- Lógica de Navegación y Sincronización ---
        function setupAllEventListeners(){
            viewSwitcherBtn.addEventListener('click', () => {
                const isCalendarActive = calendarView.classList.contains('active');
                if (isCalendarActive) {
                    calendarView.classList.remove('active');
                    kanbanView.classList.add('active');
                    viewSwitcherBtn.innerHTML = `<i class="fas fa-calendar-day"></i> Ver Calendario`;
                    document.getElementById('global-progress-header').style.display = 'flex';
                    populateKanbanBoard();
                } else {
                    kanbanView.classList.remove('active');
                    calendarView.classList.add('active');
                    viewSwitcherBtn.innerHTML = `<i class="fas fa-columns"></i> Ver Tablero Vital`;
                    document.getElementById('global-progress-header').style.display = 'none';
                    populateCalendar();
                }
            });
            // ... (resto de listeners)
        }
        
        // ... (Todas las demás funciones van aquí)

        main();
    }
    </script>
</body>
</html>
