<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frecuencia Vital - Plan de Estudios Integral</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Source+Sans+Pro:wght@300;400;600;700&display=swap');

        :root {
            --bg-color: #121212;
            --cell-bg: #1a1a1a;
            --main-border: #2c2c2c;
            --text-color: #e0e0e0;
            --accent-color: #00FF7F;
            --subject-title-color: #ffffff;
            --subject-highlight-color: #ff9800;
            --meta-bg: #181c25;
            --meta-header-bg: #101217;
            --meta-border: #2c3240;
            --meta-text: #a9bce2;
            --plan-bg: #1e1e1e;
            --vfd-green: #50E050;
            --progress-score-bg: #4caf50;
            --progress-advance-bg: #ff9800;
            --text-completed: #777;
            --bullet-completed: #555;
            --tag-text-dark: #111;
            --error-color: #ff6b6b;
            --warning-color: #ffd54f;
            --step-1-color: #03dac6; --step-2-color: #ffb74d; --step-3-color: #4fc3f7;
            --step-4-color: #ce93d8; --step-5-color: #ef9a9a; --step-6-color: #a5d6a7;
        }

        body {
            font-family: 'Source Sans Pro', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            overflow-x: hidden;
        }
        
        .main-header { text-align: center; margin-bottom: 25px; padding: 10px 0; }
        .motivational-quote { font-family: 'Orbitron', sans-serif; color: var(--vfd-green); font-size: 1.5em; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 20px; text-shadow: 0 0 4px rgba(80, 224, 80, 0.6), 0 0 8px rgba(80, 224, 80, 0.4); min-height: 1.2em; }
        .countdown-timer-container { display: flex; justify-content: center; align-items: center; gap: 25px; margin-bottom: 25px; }
        .countdown-unit { text-align: center; }
        .countdown-label { font-family: 'Orbitron', sans-serif; font-size: 0.8em; color: var(--vfd-green); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; opacity: 0.8; }
        .countdown-digits { font-family: 'Orbitron', sans-serif; font-size: 4em; color: var(--vfd-green); line-height: 1; text-shadow: 0 0 5px rgba(80, 224, 80, 0.7), 0 0 10px rgba(80, 224, 80, 0.5), 0 0 15px rgba(80, 224, 80, 0.3); }
        .topic-item.topic-completed { color: var(--text-completed); font-style: italic; }
        .topic-item.topic-completed:hover { color: var(--text-completed); background-color: transparent; }
        .topic-item.topic-completed::before { color: var(--bullet-completed); }
        .global-progress-container { max-width: 900px; margin: 30px auto; display: flex; flex-direction: column; gap: 12px; padding: 0 10px; }
        .progress-bar-wrapper { display: flex; flex-direction: column; gap: 4px; }
        .progress-bar-wrapper label { font-size: 0.85em; color: var(--meta-text); font-weight: 600; }
        .progress-bar-background { width: 100%; background-color: var(--main-border); border-radius: 8px; height: 22px; overflow: hidden; }
        .progress-bar-fill { height: 100%; width: 0%; border-radius: 8px; transition: width 0.5s ease-in-out; text-align: center; line-height: 22px; color: var(--bg-color); font-weight: bold; font-size: 0.8em; }
        #global-score-bar { background-color: var(--progress-score-bg); }
        #global-advance-bar { background-color: var(--progress-advance-bg); }
        .calendar-container { display: grid; grid-template-columns: 40px 40px repeat(7, 1fr); gap: 2px; background-color: var(--main-border); margin-top: 25px; }
        .header-cell, .day-header { text-align: center; padding: 12px 5px; font-weight: 600; font-family: 'Orbitron', sans-serif; text-transform: uppercase; font-size: 0.9em; }
        .meta-header { background-color: var(--meta-header-bg); color: var(--meta-text); border-bottom: 2px solid var(--main-border); }
        .day-header { background-color: var(--cell-bg); color: var(--accent-color); border-bottom: 2px solid var(--main-border); }
        .month-cell { grid-column: 1; background-color: var(--meta-bg); color: var(--meta-text); font-family: 'Orbitron', sans-serif; writing-mode: vertical-rl; text-transform: uppercase; letter-spacing: 2px; display: flex; align-items: center; justify-content: center; border-right: 1px solid var(--meta-border); }
        .week-cell-container { grid-column: 2; background-color: var(--meta-bg); position: relative; display: flex; align-items: center; justify-content: center; border-bottom: 1px solid var(--meta-border); }
        .week-number { font-family: 'Orbitron', sans-serif; font-size: 1.6em; color: var(--meta-text); }
        .day-cell { background-color: var(--cell-bg); min-height: 160px; padding: 8px 12px; position: relative; overflow-y: auto; cursor: pointer; }
        .day-cell.empty { background-color: var(--bg-color); cursor: default; }
        .calendar-day-number { font-size: 0.9em; font-weight: 600; color: #777; position: absolute; top: 8px; right: 12px; z-index: 1; }
        .day-content ul { list-style-type: none; padding-left: 0; margin: 25px 0 0 0; }
        .day-content li { margin-bottom: 4px; padding-left: 14px; position: relative; font-size: 0.85em; }
        .day-content .subject-title, #modal-topics .subject-title { color: var(--subject-highlight-color); font-weight: 700; display: block; margin-bottom: 6px; text-transform: uppercase; font-size: 1em; text-shadow: 0 0 5px rgba(255, 152, 0, 0.4); }
        .subject-score { color: var(--meta-text); font-size: 0.8em; font-weight: 400; margin-left: 8px; }
        .topic-item { display: flex; align-items: center; justify-content: space-between; padding: 4px 6px; margin-left: -6px; border-radius: 4px; transition: background-color 0.2s ease, color 0.2s ease; }
        .topic-item:not(.topic-completed):hover { background-color: var(--meta-bg); color: var(--accent-color); }
        .topic-item::before { content: '■'; position: absolute; left: 0; top: 5px; color: var(--accent-color); font-size: 0.8em; line-height: 1.5; transition: color 0.3s ease; }
        .topic-score { font-size: 0.85em; font-weight: bold; margin-left: 10px; flex-shrink: 0; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); z-index: 998; display: none; opacity: 0; transition: opacity 0.3s ease; }
        .modal-overlay.visible { display: block; opacity: 1; }
        .modal-container { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: var(--cell-bg); border: 1px solid var(--main-border); border-radius: 12px; box-shadow: 0 5px 25px rgba(0,0,0,0.5); z-index: 1000; width: 90%; max-height: 90vh; display: none; flex-direction: column; transition: transform 0.3s ease, opacity 0.3s ease; }
        .modal-container.visible { display: flex; }
        .modal-header { padding: 15px 25px; border-bottom: 1px solid var(--main-border); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { margin: 0; font-family: 'Orbitron', sans-serif; font-size: 1.5em; }
        .modal-close { font-size: 2em; color: #888; cursor: pointer; line-height: 1; transition: color 0.2s; }
        .modal-close:hover { color: var(--text-color); }
        .modal-content { padding: 25px; overflow-y: auto; }
        #details-modal { max-width: 650px; z-index: 1000; }
        #details-modal .modal-header h2 { color: var(--accent-color); }
        #modal-notes { width: 100%; box-sizing: border-box; min-height: 120px; background-color: #2c2c2c; border: 1px solid var(--main-border); color: var(--text-color); padding: 10px; resize: vertical; border-radius: 4px; }
        #modal-save-btn { width: 100%; padding: 12px; margin-top: 10px; background-color: var(--accent-color); color: var(--bg-color); border: none; cursor: pointer; font-family: 'Orbitron', sans-serif; font-size: 1em; border-radius: 4px; transition: background-color 0.2s, transform 0.1s; }
        #modal-save-btn:hover { background-color: #39ff94; }
        #modal-save-btn:active { transform: scale(0.98); }
        #topic-plan-modal { max-width: 900px; z-index: 1001; background-color: var(--bg-color); }
        #topic-plan-modal .modal-header h2 { color: var(--vfd-green); font-size: 1.3em; }
        #topic-plan-modal .modal-content { padding: 15px 25px; }
        #topic-plan-modal .step-card { background-color: var(--plan-bg); border-left-width: 5px; }
        .study-flow-diagram { display: flex; flex-direction: column; gap: 15px; width: 100%; }
        .step-card { border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.3); padding: 12px 18px; display: flex; align-items: flex-start; transition: opacity 0.3s ease, border-left-color 0.3s ease; border-left-style: solid; }
        .step-card.completed { border-left-color: #505050 !important; opacity: 0.65; }
        .step-card.completed .step-icon-container, .step-card.completed .step-title, .step-card.completed .step-details li { color: #909090 !important; }
        .step-card.completed .step-number { background-color: #383838 !important; color: #787878 !important; }
        .step-icon-container { font-size: 1.8em; margin-right: 15px; padding-top: 2px; min-width: 35px; text-align: center; }
        .step-content { flex-grow: 1; }
        .step-title { font-size: 1.2em; font-weight: 600; margin: 0 0 10px 0; display: flex; align-items: center; color: var(--plan-text-light); }
        .step-title .subtitle { font-size: 0.7em; color: #999; margin-left: 8px; font-weight: 400; text-transform: none; }
        .step-number { color: #101010; border-radius: 50%; width: 26px; height: 26px; display: inline-flex; align-items: center; justify-content: center; font-size: 0.7em; font-weight: bold; margin-right: 8px; flex-shrink: 0; }
        .step-details { list-style: none; padding-left: 0; margin: 0; }
        .step-details li { margin-bottom: 8px; font-size: 0.9em; line-height: 1.4; display: flex; align-items: center; color: var(--plan-text-medium); }
        .step-details li label { display: flex; align-items: center; cursor: pointer; width: 100%; }
        .step-details li .task-icon { margin-right: 10px; width: 16px; text-align: center; }
        .task-checkbox { margin-right: 10px; accent-color: var(--vfd-green); transform: scale(1.1); }
        .task-text { transition: text-decoration 0.3s ease, color 0.3s ease; }
        input[type="checkbox"]:checked + label .task-text { text-decoration: line-through; color: #6a6a6a; }
        .optional-tag { font-size: 0.8em; color: #888; margin-left: 5px; font-style: italic; }
        .tool-tag { padding: 2px 8px; border-radius: 12px; font-size: 0.75em; font-weight: 600; margin-left: 8px; border: 1px solid; }
        .tag-madera { background-color: #c8e6c9; color: var(--tag-text-dark); border-color: #a5d6a7; }
        .tag-ia { background-color: #bbdefb; color: var(--tag-text-dark); border-color: #90caf9; }
        .tag-genspark { background-color: #ffecb3; color: var(--tag-text-dark); border-color: #ffe082; }
        .tag-notebooklm { background-color: #d1c4e9; color: var(--tag-text-dark); border-color: #b39ddb; }
        .step-1 { border-left-color: var(--step-1-color); } .step-1 .step-icon-container { color: var(--step-1-color); } .step-1 .step-number { background-color: var(--step-1-color); }
        .step-2 { border-left-color: var(--step-2-color); } .step-2 .step-icon-container { color: var(--step-2-color); } .step-2 .step-number { background-color: var(--step-2-color); }
        .step-3 { border-left-color: var(--step-3-color); } .step-3 .step-icon-container { color: var(--step-3-color); } .step-3 .step-number { background-color: var(--step-3-color); }
        .step-4 { border-left-color: var(--step-4-color); } .step-4 .step-icon-container { color: var(--step-4-color); } .step-4 .step-number { background-color: var(--step-4-color); }
        .step-5 { border-left-color: var(--step-5-color); } .step-5 .step-icon-container { color: var(--step-5-color); } .step-5 .step-number { background-color: var(--step-5-color); }
        .step-6 { border-left-color: var(--step-6-color); } .step-6 .step-icon-container { color: var(--step-6-color); } .step-6 .step-number { background-color: var(--step-6-color); }
        .parallel-steps-container { display: flex; gap: 15px; }
        .parallel-steps-container .step-card { flex: 1; }
        .practice-step-layout { display: flex; flex-direction: row; gap: 15px; width: 100%; }
        .practice-tasks-column { flex: 2; }
        .practice-score-column { flex: 1; }
        .practice-score-column h3 { font-size: 0.9em; color: #ccc; margin: 0 0 8px 0; font-weight: 500; text-transform: uppercase; }
        .score-inputs-row { display: flex; gap: 8px; }
        .score-input-group { flex-grow: 1; }
        .score-input-group label { font-size: 0.75em; color: #bbb; }
        .score-input-group input { font-family: 'Source Sans Pro', sans-serif; background-color: #2a2a2a; color: #e0e0e0; border: 1px solid #444; border-radius: 4px; padding: 5px 8px; font-size: 0.9em; width: 100%; box-sizing: border-box; text-align: center; }
        .score-input-group input[type=number]::-webkit-inner-spin-button, .score-input-group input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .score-input-group input[type=number] { -moz-appearance: textfield; }
        .percentage-output { font-weight: bold; background-color: var(--plan-bg) !important; cursor: default; }
        .topic-modal-footer { margin-top: 25px; padding-top: 15px; border-top: 1px solid var(--main-border); text-align: right; }
        .topic-finish-btn { background-color: var(--vfd-green); color: var(--bg-color); border: none; border-radius: 6px; padding: 12px 25px; font-family: 'Orbitron', sans-serif; font-size: 1em; font-weight: 700; text-transform: uppercase; cursor: pointer; transition: background-color 0.2s ease, transform 0.2s ease; }
        .topic-finish-btn:hover { background-color: #76ff76; transform: translateY(-2px); }
        
        @media (max-width: 768px) { .motivational-quote { font-size: 1.2em; } .countdown-digits { font-size: 3em; } .countdown-timer-container { gap: 15px; } .parallel-steps-container, .practice-step-layout { flex-direction: column; } .day-cell { min-height: 120px; } }
        @media (max-width: 600px) { .motivational-quote { font-size: 1em; letter-spacing: 1px; } .countdown-digits { font-size: 2.2em; } .countdown-label { font-size: 0.6em; } .countdown-timer-container { gap: 10px; } body { padding: 10px; } .calendar-container { grid-template-columns: 30px 30px repeat(7, 1fr); } .modal-content { padding: 15px; } .step-card { flex-direction: column; } .step-icon-container { text-align: left; margin-bottom: 5px;} }
    </style>
</head>
<body>
    <header class="main-header">
        <div id="motivational-quote-container" class="motivational-quote"></div>
        <div class="countdown-timer-container">
            <div class="countdown-unit"> <div class="countdown-label">Days</div> <div class="countdown-digits" id="countdown-days">000</div> </div>
            <div class="countdown-unit"> <div class="countdown-label">Hours</div> <div class="countdown-digits" id="countdown-hours">00</div> </div>
            <div class="countdown-unit"> <div class="countdown-label">Minutes</div> <div class="countdown-digits" id="countdown-minutes">00</div> </div>
            <div class="countdown-unit"> <div class="countdown-label">Seconds</div> <div class="countdown-digits" id="countdown-seconds">00</div> </div>
        </div>
        <div class="global-progress-container">
            <div class="progress-bar-wrapper">
                <label id="global-score-label">Puntuación Global (Promedio de Calificaciones)</label>
                <div class="progress-bar-background">
                    <div class="progress-bar-fill" id="global-score-bar" role="progressbar" aria-labelledby="global-score-label">0%</div>
                </div>
            </div>
            <div class="progress-bar-wrapper">
                <label id="global-advance-label">Avance Global (Temas Completados)</label>
                <div class="progress-bar-background">
                    <div class="progress-bar-fill" id="global-advance-bar" role="progressbar" aria-labelledby="global-advance-label">0%</div>
                </div>
            </div>
        </div>
    </header>

    <div class="calendar-container" id="calendar-container"></div>

    <div class="modal-overlay" id="modal-overlay"></div>
    <div class="modal-container" id="details-modal">
        <div class="modal-header"> <h2 id="modal-title"></h2> <span class="modal-close" id="modal-close-day">×</span> </div>
        <div class="modal-content"> <div id="modal-topics"></div> <div class="notes-section" style="margin-top: 20px;"> <h3>Mis Anotaciones del Día</h3> <textarea id="modal-notes" placeholder="Escribe aquí tus notas generales para este día..."></textarea> <button id="modal-save-btn">Guardar Nota</button> </div> </div>
    </div>
    <div class="modal-overlay" id="topic-plan-overlay"></div>
    <div class="modal-container" id="topic-plan-modal">
        <div class="modal-header"> <h2 id="topic-plan-title"></h2> <span class="modal-close" id="modal-close-topic">×</span> </div>
        <div class="modal-content">
            <div class="study-flow-diagram">
                <!-- VISTA RÁPIDA -->
                <div class="step-card step-1">
                    <div class="step-icon-container"><i class="fas fa-binoculars"></i></div>
                    <div class="step-content">
                        <h2 class="step-title"><span class="step-number">1</span>VISTA RÁPIDA</h2>
                        <ul class="step-details">
                            <li><label><input type="checkbox" class="task-checkbox" id="task-1-1"><i class="fas fa-list-ul task-icon"></i><span class="task-text">Índice</span><span class="tool-tag tag-madera">MADERA</span></label></li>
                            <li><label><input type="checkbox" class="task-checkbox" id="task-1-2"><i class="fas fa-download task-icon"></i><span class="task-text">Descargar guías</span><span class="optional-tag">* opcional</span></label></li>
                            <li><label><input type="checkbox" class="task-checkbox" id="task-1-3"><i class="fas fa-brain task-icon"></i><span class="task-text">CREA resúmenes + casos con IA (5min)</span><span class="tool-tag tag-ia">IAGOOGLE</span></label></li>
                        </ul>
                    </div>
                </div>
                <!-- CREAR y LEER -->
                <div class="parallel-steps-container">
                    <div class="step-card step-2">
                        <div class="step-icon-container"><i class="fas fa-magic"></i></div>
                        <div class="step-content">
                            <h2 class="step-title"><span class="step-number">2</span>CREAR</h2>
                            <ul class="step-details">
                                <li><label><input type="checkbox" class="task-checkbox" id="task-2-1"><i class="fas fa-chalkboard-teacher task-icon"></i><span class="task-text">Presentación</span><span class="tool-tag tag-genspark">Genspark</span></label></li>
                                <li><label><input type="checkbox" class="task-checkbox" id="task-2-2"><i class="fas fa-microphone-alt task-icon"></i><span class="task-text">Podcast MP3</span><span class="tool-tag tag-notebooklm">NOTEBOOKLM</span></label></li>
                            </ul>
                        </div>
                    </div>
                    <div class="step-card step-3">
                        <div class="step-icon-container"><i class="fas fa-book-reader"></i></div>
                        <div class="step-content">
                            <h2 class="step-title"><span class="step-number">3</span>LEER</h2>
                            <ul class="step-details">
                                <li><label><input type="checkbox" class="task-checkbox" id="task-3-1"><i class="fas fa-file-alt task-icon"></i><span class="task-text">Leer Resumen</span></label></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <!-- UNIFICAR -->
                <div class="step-card step-4">
                    <div class="step-icon-container"><i class="fas fa-puzzle-piece"></i></div>
                    <div class="step-content">
                        <h2 class="step-title"><span class="step-number">4</span>UNIFICAR<span class="subtitle">(resumen + presentación + simular + enlaces)</span></h2>
                        <ul class="step-details">
                            <li><label><input type="checkbox" class="task-checkbox" id="task-4-1"><i class="fas fa-code task-icon"></i><span class="task-text">HTML</span><span class="tool-tag tag-ia">IAGOOGLE</span></label></li>
                        </ul>
                    </div>
                </div>
                <!-- PRACTICAR -->
                <div class="step-card step-5">
                    <div class="step-icon-container"><i class="fas fa-tasks"></i></div>
                    <div class="step-content">
                        <h2 class="step-title"><span class="step-number">5</span>PRACTICAR</h2>
                        <div class="practice-step-layout">
                            <div class="practice-tasks-column">
                                <ul class="step-details">
                                    <li><label><input type="checkbox" class="task-checkbox" id="task-5-1"><i class="fas fa-notes-medical task-icon"></i><span class="task-text">Realiza CASOS CLÍNICOS</span></label></li>
                                    <li><label><input type="checkbox" class="task-checkbox" id="task-5-2"><i class="fas fa-redo-alt task-icon"></i><span class="task-text">Repasar</span><span class="tool-tag tag-genspark">GENSPARK</span><span class="tool-tag tag-madera">MADERAS</span></label></li>
                                </ul>
                            </div>
                            <div class="practice-score-column">
                                <h3>PUNTUACIÓN</h3>
                                <div class="score-inputs-row">
                                    <div class="score-input-group"><label for="score-aciertos">Aciertos:</label><input type="number" id="score-aciertos" min="0"></div>
                                    <div class="score-input-group"><label for="score-reactivos">Reactivos:</label><input type="number" id="score-reactivos" min="0"></div>
                                    <div class="score-input-group"><label for="score-percentage">%:</label><input type="text" id="score-percentage" class="percentage-output" readonly value="0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- MEMORIZAR -->
                <div class="step-card step-6">
                    <div class="step-icon-container"><i class="fas fa-head-side-headphones"></i></div>
                    <div class="step-content">
                        <h2 class="step-title"><span class="step-number">6</span>MEMORIZAR</h2>
                        <ul class="step-details">
                            <li><label><input type="checkbox" class="task-checkbox" id="task-6-1"><i class="fas fa-headphones-alt task-icon"></i><span class="task-text">Escuchar MP3</span></label></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="topic-modal-footer"> <button id="topic-finish-btn" class="topic-finish-btn">Terminar Tema</button> </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
    const firebaseConfig = {
        apiKey: "AIzaSyD4SjKhedm4ZWHed70_sjQgxPokjHvwvUc",
        authDomain: "frecuencia-vital.firebaseapp.com",
        projectId: "frecuencia-vital",
        storageBucket: "frecuencia-vital.appspot.com",
        messagingSenderId: "492064882273",
        appId: "1:492064882273:web:46ad9f9a66126bfdb53420",
        measurementId: "G-0C466YCX31"
    };
    
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.firestore();
    let currentUser = null;
    
    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            initializeAppLogic();
        } else {
            window.location.href = 'index.html';
        }
    });

    function initializeAppLogic() {
        const subjectToTopicsMap = new Map();
        const motivationalQuotes = [ "La disciplina es el puente entre metas y logros.", "El éxito es la suma de pequeños esfuerzos repetidos día tras día.", "No te detengas hasta que te sientas orgulloso.", "Cree en ti mismo y todo será posible.", "El único modo de hacer un gran trabajo es amar lo que haces.", "La clave del éxito es empezar antes de estar listo.", "Cada día es una nueva oportunidad para cambiar tu vida.", "Si puedes soñarlo, puedes hacerlo.", "La perseverancia no es una carrera larga, son muchas carreras cortas una tras otra.", "El aprendizaje es un tesoro que seguirá a su dueño a todas partes.", "La motivación te pone en marcha, el hábito te mantiene.", "No cuentes los días, haz que los días cuenten.", "El futuro pertenece a quienes creen en la belleza de sus sueños.", "La mejor forma de predecir el futuro es crearlo.", "Un pequeño progreso cada día suma grandes resultados." ];
        const studyPlan = [
            { date: "2025-06-18", subjects: ["ENDOCRINOLOGÍA"], topics: ["Dislipidemias", "Hipertiroidismo", "Hipotiroidismo", "Cáncer de tiroides (Enfoque en Papilar)"] },
            { date: "2025-06-19", subjects: [], topics: ["Nódulo tiroideo", "Obesidad en adultos", "Síndrome metabólico", "Enfermedad de Cushing / Síndrome de Cushing"] },
            { date: "2025-06-20", subjects: ["UROLOGÍA"], topics: ["Enfermedad de Addison", "Escroto agudo y Torsión testicular", "Hiperplasia prostática benigna", "Cáncer de próstata"] },
            { date: "2025-06-21", subjects: [], topics: ["Pielonefritis aguda", "Infección de tracto urinario", "Urolitiasis", "Cáncer testicular"] },
            { date: "2025-06-22", subjects: ["ORL"], topics: ["Disfunción eréctil", "Faringoamigdalitis", "Epistaxis", "Rinosinusitis aguda"] },
            { date: "2025-06-23", subjects: [], topics: ["Otitis externa aguda", "VPPB", "Mastoiditis aguda", "Parálisis de Bell"] },
            { date: "2025-06-24", subjects: ["OFTALMOLOGÍA"], topics: ["Catarata", "Conjuntivitis", "Glaucoma de ángulo aberto", "Glaucoma de ángulo cerrado"] },
            { date: "2025-06-25", subjects: [], topics: ["Ojo rojo", "Retinopatía diabética", "Trauma ocular", "Desprendimiento de retina"] },
            { date: "2025-06-26", subjects: ["TYO"], topics: ["Osteoartritis", "Osteomielitis", "Fracturas expuestas", "Esguince cervical", "Lumbalgia"] },
            { date: "2025-06-27", subjects: [], topics: ["Síndrome de hombro doloroso", "Luxación glenohumeral", "Fractura de clavícula", "Fractura de radio distal"] },
            { date: "2025-06-28", subjects: [], topics: ["Fractura de cadera", "Lesiones de rodilla", "Esguince de tobillo", "Fractura de tobillo"] },
            { date: "2025-06-29", subjects: [], topics: ["Osteosarcoma", "Sarcoma de Ewing", "Hernia de disco", "Túnel del carpo"] },
            { date: "2025-06-30", subjects: [], topics: ["Epifisiolistesis femoral", "Legg-Calvé-Perthes", "Embolia grasa", "Tumores óseos malignos"] },
            { date: "2025-07-01", subjects: [], topics: ["Costilla cervical", "Fractura de húmero proximal", "Luxación de codo", "Codo de niñera"] },
            { date: "2025-07-02", subjects: [], topics: ["Fracturas de codo", "Fracturas de antebrazo", "Lesiones fisiarias", "Luxación coxofemoral", "Fractura de diáfisis de tibia"] },
            { date: "2025-07-03", subjects: ["CARDIOLOGÍA"], topics: ["Rotura de talón de Aquiles", "Pie equino varo", "Pie plano", "Pericarditis"] },
            { date: "2025-07-04", subjects: [], topics: ["Endocarditis infecciosa", "Estenosis aórtica", "Insuficiencia aórtica", "Estenosis mitral"] },
            { date: "2025-07-05", subjects: [], topics: ["Insuficiencia mitral", "Fiebre reumática", "Hipertensión arterial sistémica", "Crisis hipertensivas"] },
            { date: "2025-07-06", subjects: [], topics: ["Insuficiencia cardíaca aguda", "Insuficiencia cardíaca crónica", "Infarto agudo de miocardio", "Disección aórtica"] },
            { date: "2025-07-07", subjects: [], topics: ["Cor pulmonar crónico", "Edema pulmonar", "Hipotensión ortostática", "Aneurisma aórtico abdominal"] },
            { date: "2025-07-08", subjects: [], topics: ["Enfermedad coronaria", "Otras valvulopatías", "Hipertensión pulmonar", "Rehabilitación cardíaca"] },
            { date: "2025-07-09", subjects: ["ANGIOLOGÍA"], topics: ["Enfermedad arterial periférica", "Insuficiencia venosa", "Pie diabético", "Tromboembolia pulmonar"] },
            { date: "2025-07-10", subjects: [], topics: ["Trombosis venosa profunda", "Úlceras por presión", "Paget-Schroetter", "Tromboembolia venosa en obstetricia"] },
            { date: "2025-07-11", subjects: ["ACLS"], topics: ["Soporte vital básico", "RCP", "Taquicardia ACLS", "Taquicardia supraventricular"] },
            { date: "2025-07-12", subjects: [], topics: ["Bloqueos AV", "Bradicardia", "Fibrilación auricular", "Fibrilación ventricular"] },
            { date: "2025-07-13", subjects: ["ATLS"], topics: ["Síndrome de WPW", "PLS (Posición Lateral de Seguridad)", "Ahogamiento", "Politrauma"] },
            { date: "2025-07-14", subjects: [], topics: ["Tipos de shock", "Choque hipovolémico", "Quemaduras", "Gran quemado"] },
            { date: "2025-07-15", subjects: [], topics: ["TCE adultos", "TCE pediátrico", "Trauma torácico", "Hemotórax"] },
            { date: "2025-07-16", subjects: [], topics: ["Neumotórax a tensión", "Taponamiento cardiaco", "Trauma abdominal", "Shock neurogénico"] },
            { date: "2025-07-17", subjects: [], topics: ["Neumotórax aberto", "Neumotórax simple", "Trauma espinal", "Catéter venoso central"] },
            { date: "2025-07-18", subjects: [], topics: ["Hipotermia", "Fracturas de cráneo", "Lesión traqueobronquial", "Ruptura diafragmática"] },
            { date: "2025-07-19", subjects: ["TOXICOLOGÍA"], topics: ["Trauma esplénico", "Trauma obstétrico", "Trauma pélvico", "Manejo de intoxicaciones", "Toxíndromes"] },
            { date: "2025-07-20", subjects: [], topics: ["Intoxicación por benzodiacepinas", "Intoxicación por organofosforados", "Intoxicación por paracetamol", "Intoxicación por salicilatos"] },
            { date: "2025-07-21", subjects: [], topics: ["Lactrodectus", "Loxosceles", "Mordedura de serpiente", "Picadura de alacrán"] },
            { date: "2025-07-22", subjects: [], topics: ["Golpe de calor", "Intoxicación por etanol", "Intoxicación por monóxido de carbono", "Intoxicación por opiáceos"] },
            { date: "2025-07-23", subjects: [], topics: ["Anafilaxia", "Ingesta de cáusticos", "Intoxicación alimentaria", "Intoxicación por alcoholes"] },
            { date: "2025-07-24", subjects: [], topics: ["Intoxicación por anfetaminas", "Intoxicación por DMT", "Intoxicación por fentanilo", "Intoxicación por hidrocarburos"] },
            { date: "2025-07-25", subjects: ["GASTROENTEROLOGÍA"], topics: ["Intoxicación por metales pesados", "Intoxicación por plomo", "Picadura de himenópteros", "Absceso hepático amebiano"] },
            { date: "2025-07-26", subjects: [], topics: ["Cirrosis hepática", "Insuficiencia hepática", "Ascitis", "Encefalopatía hepática"] },
            { date: "2025-07-27", subjects: [], topics: ["Hepatitis A", "Hepatitis B", "Hepatitis C", "Pancreatitis aguda"] },
            { date: "2025-07-28", subjects: [], topics: ["Reflujo ERGE", "Enfermedad ácido péptica", "Síndrome de intestino irritable", "Sangrado TDA"] },
            { date: "2025-07-29", subjects: [], topics: ["Sangrado TDB", "Várices esofágicas", "EHGNA", "Enfermedad de Crohn"] },
            { date: "2025-07-30", subjects: [], topics: ["Colitis ulcerativa", "Cáncer gástrico", "Carcinoma hepatocelular", "Absceso hepático piógeno"] },
            { date: "2025-07-31", subjects: [], topics: ["Hepatitis autoinmune", "Pancreatitis crónica", "Acalasia", "Esófago de Barret"] },
            { date: "2025-08-01", subjects: [], topics: ["Dispepsia funcional", "Mallory Weiss", "Zollinger-Ellison", "Enfermedad celíaca", "Cáncer de esófago"] },
            { date: "2025-08-02", subjects: ["CIRUGÍA ABDOMINAL Y COLOPROCTOLOGÍA"], topics: ["Cáncer de páncreas", "Apendicitis aguda", "Apendicitis en el embarazo", "Colecistitis aguda"] },
            { date: "2025-08-03", subjects: [], topics: ["Coledocolitiasis", "Colelitiasis", "Colangitis aguda", "Hernias"] },
            { date: "2025-08-04", subjects: [], topics: ["Hernia inguinal", "Oclusión intestinal", "Enfermedad hemorroidal", "Fístula anal"] },
            { date: "2025-08-05", subjects: [], topics: ["Fisura anal", "Absceso anal", "Enfermedad diverticular", "Cáncer colorrectal"] },
            { date: "2025-08-06", subjects: [], topics: ["Isquemia intestinal", "Vólvulo de sigmoides", "Heridas quirúrgicas", "Complicaciones post Qx"] },
            { date: "2025-08-07", subjects: [], topics: ["Colangiocarcinoma", "Fístulas biliointestinales", "Hernia femoral", "Hernia hiatal"] },
            { date: "2025-08-08", subjects: [], topics: ["Hernia umbilical", "Hernia ventral", "Vólvulo de ciego", "Quiste pilonidal", "Poliposis adenomatosa familiar (PAF)"] },
            { date: "2025-08-09", subjects: ["CIRUGÍA PEDIÁTRICA"], topics: ["Atresia duodenal", "Atresia esofágica", "Criptorquidia", "Estenosis pilórica"] },
            { date: "2025-08-10", subjects: [], topics: ["Hernia diafragmática congénita", "Invaginación intestinal", "Nefroblastoma", "Neuroblastoma"] },
            { date: "2025-08-11", subjects: [], topics: ["Divertículo de Meckel", "Hirschsprung", "Atresia biliar", "Atresia de coanas"] },
            { date: "2025-08-12", subjects: [], topics: ["Atresia yeyunoileal", "Espina bífida", "Malformaciones rectales", "Malrotación intestinal", "Patología umbilical"] }, 
            { date: "2025-08-13", subjects: ["GINECOLOGÍA"], topics: ["Fitz-Hugh-Curtis", "Dismenorrea aguda", "Amenorreas primarias", "Amenorreas secundarias", "Sangrado uterino anormal"] },
            { date: "2025-08-14", subjects: [], topics: ["Adenomiosis", "Anticonceptivos generalidades", "Anticonceptivos GPC", "Anticonceptivos hormonales combinados", "Anticoncepción de emergencia"] },
            { date: "2025-08-15", subjects: [], topics: ["DIU de cobre", "DIU de levonorgestrel", "Implante subdérmico", "Progestágenos solos", "Lactancia como anticonceptivo"] },
            { date: "2025-08-16", subjects: [], topics: ["Infertilidad", "Condón", "Vasectomía", "Cistocele e incontinencia", "Endometriosis"] },
            { date: "2025-08-17", subjects: [], topics: ["Enfermedad pélvica inflamatoria", "Hidrosalpinx", "Hiperplasia endometrial", "Mastitis", "Mastopatía fibroquística"] },
            { date: "2025-08-18", subjects: [], topics: ["Fibroadenoma", "Papiloma intraductal", "Patología mamaria benigna", "Quiste mamario", "Osteoporosis post menopausia"] },
            { date: "2025-08-19", subjects: [], topics: ["Insuficiencia ovárica primaria", "Menopausia y climaterio", "Miomatosis uterina", "Oclusión tubaria bilateral OTB", "Ovario poliquístico"] },
            { date: "2025-08-20", subjects: [], topics: ["Quiste de ovario benigno", "Torsión ovárica", "Vaginitis bacteriana", "Vaginitis infecciosa", "Trichomoniasis"] },
            { date: "2025-08-21", subjects: ["ONCOGINE"], topics: ["Bartolinitis", "Candidiasis vulvovaginal", "Chlamydia", "Tamizaje cáncer de mama", "Cáncer de mama"] },
            { date: "2025-08-22", subjects: [], topics: ["Cáncer cérvicouterino", "Cáncer de endometrio", "Cáncer de ovario", "Cáncer de vagina", "Tumores anexiales"] },
            { date: "2025-08-23", subjects: ["OBSTETRICIA"], topics: ["Control prenatal", "Aloinmunización materna", "Estática fetal", "Tipos de pelvis", "Atención del parto"] },
            { date: "2025-08-24", subjects: [], topics: ["Manejo activo del parto", "Cesárea", "Parto pretérmino", "Puerperio fisiológico", "Líquido amniótico"] },
            { date: "2025-08-25", subjects: [], topics: ["Ruptura prematura de membranas", "Corioamnionitis", "Distocias", "Embarazo múltiple", "Endometritis puerperal"] },
            { date: "2025-08-26", subjects: [], topics: ["Hiperémesis gravídica", "Insuficiencia cervical", "Muerte fetal", "Enfermedades hipertensivas del embarazo", "Preeclampsia sin datos de severidad"] },
            { date: "2025-08-27", subjects: [], topics: ["Síndrome de HELLP", "Diabetes gestacional", "IVU en el embarazo", "Restricción del crecimiento intrauterino", "Sepsis puerperal"] },
            { date: "2025-08-28", subjects: ["HEMORRAGIAS OBSTÉTRICAS"], topics: ["Síndrome de Sheehan", "Depresión posparto", "Generalidades de hemorragias", "Hemorragia postparto", "Desgarro perineal"] },
            { date: "2025-08-29", subjects: [], topics: ["Amenaza de aborto", "Aborto espontáneo", "Acretismo placentario", "Atonía uterina", "Choque hemorrágico en obstetricia"] },
            { date: "2025-08-30", subjects: [], topics: ["Desprendimiento prematuro de placenta normoinserta", "Embarazo ectópico", "Placenta previa", "Ruptura uterina", "Vasa previa"] },
            { date: "2025-08-31", subjects: ["NEONATOLOGÍA"], topics: ["Enfermedad trofoblástica gestacional", "APGAR", "Apnea del prematuro", "Asfixia neonatal", "Displasia broncopulmonar"] },
            { date: "2025-09-01", subjects: [], topics: ["Silverman Anderson", "Síndrome de aspiración de meconio", "Maduración pulmonar", "Síndrome de dificultad respiratoria", "Encefalopatía hipóxica"] },
            { date: "2025-09-02", subjects: [], topics: ["Enfermedad hemorrágica del recién nacido", "Enterocolitis necrotizante", "Hipoacusia neonatal", "Hipoglucemia neonatal", "Ictericia neonatal"] },
            { date: "2025-09-03", subjects: [], topics: ["Muerte súbita del lactante", "Prematuro sano", "Reanimación neonatal", "Recién nacido de término", "Sepsis neonatal"] },
            { date: "2025-09-04", subjects: [], topics: ["Tamiz neonatal", "Taquipnea transitoria del recién nacido", "Lesiones de plexo braquial obstétrico", "Lesiones extracraneales", "Displasia del desarrollo de la cadera DDC"] },
            { date: "2025-09-05", subjects: ["CONGENITAS"], topics: ["Hirschsprung", "Cardiopatías congénitas", "Tetralogía de Fallot", "Coartación aórtica", "Persistencia del conducto arterioso"] },
            { date: "2025-09-06", subjects: [], topics: ["Fenilcetonuria", "Fibrosis quística", "Galactosemia clásica", "Storch", "Storch Citomegalovirus"] },
            { date: "2025-09-07", subjects: [], topics: ["Storch herpes simple", "Storch rubéola congénita", "Storch sífilis congénita", "Storch toxoplasmosis", "Storch varicela congénita"] },
            { date: "2025-09-08", subjects: ["ESCOLAR"], topics: ["Control de niño sano", "Etapas del crecimiento", "Talla baja", "Alergia alimentaria", "Cuerpo extraño"] },
            { date: "2025-09-09", subjects: [], topics: ["Dermatitis del pañal", "Estreñimiento funcional", "Hiperplasia adrenal congénita", "Hipotiroidismo congénito", "Maltrato infantil"] },
            { date: "2025-09-10", subjects: [], topics: ["Mucopolisacaridosis", "Reflujo gastroesofágico del lactante"] },
            { date: "2025-09-11", subjects: ["NUTRICIÓN PEDIÁTRICA"], topics: ["Alimentación complementaria", "Deficiencia de vitamina A", "Desnutrición pediátrica", "Hipovitaminosis", "Intolerancia a la lactosa", "Lactancia materna"] },
            { date: "2025-09-12", subjects: [], topics: ["Obesidad en escolares", "Pelagra en niños", "Raquitismo carencial", "Síndrome metabólico en niños"] },
            { date: "2025-09-13", subjects: ["INFECTOLOGÍA PEDIÁTRICA"], topics: ["Adenitis mesentérica", "Onfalitis", "Exantemáticas Diferencial", "Eritema infeccioso", "Escarlatina", "Exantema súbito"] },
            { date: "2025-09-14", subjects: [], topics: ["Enfermedad de Kawasaki", "Síndrome mano pie boca", "Rubéola", "Sarampión", "Varicela", "Parotiditis"] },
            { date: "2025-09-15", subjects: [], topics: ["Bronquiolitis", "Epiglotitis", "Laringotraqueitis CRUP", "Mononucleosis infecciosa", "Tos ferina", "IVU en menores"] },
            { date: "2025-09-16", subjects: ["VACUNAS"], topics: ["Vacunas generalidades", "Tipos de vacunas", "Vacunación universal", "Aplicación de vacunas", "Vacuna para personal de salud", "Vacunas en el embarazo"] },
            { date: "2025-09-17", subjects: [], topics: ["Esquema de vacunación", "Bcg", "Hepatitis A", "Hepatitis B", "Hexavalente", "Influenza", "Neumocócica"] },
            { date: "2025-09-18", subjects: [], topics: ["Rotavirus", "Sabin", "Salmonella", "Dpt", "Srp", "Tétanos", "Varicela", "Vph"] }
        ];

        let userProgress = {};
        const totalTopics = studyPlan.reduce((acc, day) => acc + day.topics.length, 0);
        const ALL_TASK_IDS = ['task-1-1', 'task-1-2', 'task-1-3', 'task-2-1', 'task-2-2', 'task-3-1', 'task-4-1', 'task-5-1', 'task-5-2', 'task-6-1'];
        
        const calendarContainer = document.getElementById('calendar-container');
        const dayModal = document.getElementById('details-modal'), dayModalOverlay = document.getElementById('modal-overlay'), dayModalTitle = document.getElementById('modal-title'), dayModalTopicsContainer = document.getElementById('modal-topics'), dayModalNotes = document.getElementById('modal-notes'), saveNoteButton = document.getElementById('modal-save-btn');
        const topicModal = document.getElementById('topic-plan-modal'), topicModalOverlay = document.getElementById('topic-plan-overlay'), topicModalTitle = document.getElementById('topic-plan-title'), topicStepCards = topicModal.querySelectorAll('.step-card'), topicTaskCheckboxes = topicModal.querySelectorAll('.task-checkbox'), aciertosInput = document.getElementById('score-aciertos'), reactivosInput = document.getElementById('score-reactivos'), percentageOutput = document.getElementById('score-percentage'), finishTopicButton = document.getElementById('topic-finish-btn');
        const globalScoreBar = document.getElementById('global-score-bar'), globalAdvanceBar = document.getElementById('global-advance-bar');
        
        function getScoreColor(percentage) {
            if (percentage < 60) return 'var(--error-color)';
            if (percentage < 80) return 'var(--warning-color)';
            return 'var(--vfd-green)';
        }

        function displayDailyQuote() {
            const quoteContainer = document.getElementById('motivational-quote-container');
            if (quoteContainer) {
                const randomIndex = Math.floor(Math.random() * motivationalQuotes.length);
                quoteContainer.textContent = motivationalQuotes[randomIndex];
            }
        }

        function startCountdown() {
            const targetDate = new Date("2025-09-18T08:00:00").getTime();
            const daysEl = document.getElementById('countdown-days');
            const hoursEl = document.getElementById('countdown-hours');
            const minutesEl = document.getElementById('countdown-minutes');
            const secondsEl = document.getElementById('countdown-seconds');
            if (!daysEl || !hoursEl || !minutesEl || !secondsEl) return;
            const interval = setInterval(() => {
                const now = new Date().getTime();
                const distance = targetDate - now;
                if (distance < 0) {
                    clearInterval(interval);
                    daysEl.textContent = "000"; hoursEl.textContent = "00"; minutesEl.textContent = "00"; secondsEl.textContent = "00";
                    return;
                }
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                daysEl.textContent = String(days).padStart(3, '0');
                hoursEl.textContent = String(hours).padStart(2, '0');
                minutesEl.textContent = String(minutes).padStart(2, '0');
                secondsEl.textContent = String(seconds).padStart(2, '0');
            }, 1000);
        }

        function buildSubjectMap() {
            let lastSubjects = [];
            studyPlan.forEach(day => {
                const subjectsForThisDay = day.subjects.length > 0 ? day.subjects : lastSubjects;
                if(day.subjects.length > 0) {
                    lastSubjects = day.subjects;
                }
                const dayTopicIds = day.topics.map(topicName => generateTopicId(day.date, topicName));
                subjectsForThisDay.forEach(subjectName => {
                    if (!subjectToTopicsMap.has(subjectName)) {
                        subjectToTopicsMap.set(subjectName, []);
                    }
                    const currentTopics = subjectToTopicsMap.get(subjectName);
                    const updatedTopics = new Set([...currentTopics, ...dayTopicIds]);
                    subjectToTopicsMap.set(subjectName, Array.from(updatedTopics));
                });
            });
        }

        function calculateSubjectScore(subjectName) {
            const topicIds = subjectToTopicsMap.get(subjectName);
            if (!topicIds || topicIds.length === 0) return null;
            let totalScoreSum = 0;
            let scoredTopicsCount = 0;
            topicIds.forEach(topicId => {
                const reactivos = parseInt(getData(`topicData.${topicId}.scoreReactivos`)) || 0;
                if (reactivos > 0) {
                    const aciertos = parseInt(getData(`topicData.${topicId}.scoreAciertos`)) || 0;
                    totalScoreSum += (aciertos / reactivos) * 100;
                    scoredTopicsCount++;
                }
            });
            return scoredTopicsCount > 0 ? Math.round(totalScoreSum / scoredTopicsCount) : null;
        }

        function loadUserProgress(data) {
            if (data) { userProgress = data; } 
            else { userProgress = {}; }
        }

// =========================================================================
// ============ REEMPLAZA TU FUNCIÓN saveData ENTERA CON ESTO ============
// =========================================================================

async function saveData(key, value) {
    if (!currentUser) return;
    const docRef = db.collection('userProgress').doc(currentUser.uid);

    // Esta es la sintaxis correcta que Firestore entiende para campos anidados.
    const dataToUpdate = { [key]: value };

    // Usamos set con merge:true que es robusto tanto para crear como para actualizar.
    // El error anterior estaba en cómo se construía el objeto, no tanto en el método.
    await docRef.set(dataToUpdate, { merge: true }).catch(error => {
        console.error("Error al guardar los datos en Firestore: ", error);
    });

    console.log(`Dato guardado: { ${key}: "${value}" }`);

    // Actualizar el objeto local para que la UI sea instantánea
    const keys = key.split('.');
    let current = userProgress;
    for (let i = 0; i < keys.length - 1; i++) {
        current = current[keys[i]] = current[keys[i]] || {};
    }
    current[keys[keys.length - 1]] = value;
}

        function getData(key, defaultValue = null) {
            const keys = key.split('.');
            let result = userProgress;
            for (const k of keys) {
                if (result && typeof result === 'object' && k in result) { result = result[k]; } 
                else { return defaultValue; }
            }
            return result;
        }

        function isTopicComplete(topicId) { return ALL_TASK_IDS.every(taskId => getData(`topicData.${topicId}.${taskId}`) === true); }
        function generateTopicId(dateString, topicName) { const cleanTopic = topicName.toLowerCase().replace(/[^a-z0-9]/g, ''); return `topic_${dateString}_${cleanTopic}`; }
        
        function createTopicListItem(topic, dateString) {
            const topicId = generateTopicId(dateString, topic);
            const isComplete = isTopicComplete(topicId);
            const liClass = `topic-item ${isComplete ? 'topic-completed' : ''}`;
            let scoreHTML = '';
            const reactivos = parseInt(getData(`topicData.${topicId}.scoreReactivos`)) || 0;
            if (reactivos > 0) {
                const aciertos = parseInt(getData(`topicData.${topicId}.scoreAciertos`)) || 0;
                const percentage = Math.round((aciertos / reactivos) * 100);
                const color = getScoreColor(percentage);
                scoreHTML = `<span class="topic-score" style="color: ${color};">(${percentage}%)</span>`;
            }
            return `<li class="${liClass}" data-topic-id="${topicId}" data-topic-name="${topic}"><span>${topic}</span>${scoreHTML}</li>`;
        }
        
        function populateCalendar() {
            const daysMap = new Map(studyPlan.map(day => [day.date, day]));
            const startDate = new Date(studyPlan[0].date + "T00:00:00");
            const visualEndDate = new Date("2025-09-27T23:59:59"); 
            const calendarGridEndDate = new Date(visualEndDate.getFullYear(), visualEndDate.getMonth() + 1, 0, 23, 59, 59);
            let weeks = []; let dateCursor = new Date(startDate); dateCursor.setDate(dateCursor.getDate() - dateCursor.getDay());
            while (dateCursor <= calendarGridEndDate) { let week = []; for(let i=0; i < 7; i++) { week.push(new Date(dateCursor)); dateCursor.setDate(dateCursor.getDate() + 1); } weeks.push(week); }
            const monthLayout = new Map(); weeks.forEach((week, weekIndex) => { const firstDayOfWeek = week[0]; const monthName = firstDayOfWeek.toLocaleString('es-ES', { month: 'long' }); if (!monthLayout.has(monthName)) { monthLayout.set(monthName, { startRow: weekIndex + 2, rowSpan: 1 }); } else { monthLayout.get(monthName).rowSpan++; } });
            calendarContainer.innerHTML = ''; calendarContainer.innerHTML += '<div class="header-cell meta-header">M</div><div class="header-cell meta-header">S</div>'; ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'].forEach(day => calendarContainer.innerHTML += `<div class="header-cell day-header">${day}</div>`);
            monthLayout.forEach((layout, name) => { calendarContainer.innerHTML += `<div class="month-cell" style="grid-row: ${layout.startRow} / span ${layout.rowSpan}">${name}</div>`; });
            weeks.forEach((week, weekIndex) => {
                calendarContainer.innerHTML += `<div class="week-cell-container" style="grid-row: ${weekIndex + 2}"><span class="week-number">${weekIndex + 1}</span></div>`;
                week.forEach(date => {
                    const cell = document.createElement('div');
                    cell.className = 'day-cell';
                    const dateString = date.toISOString().split('T')[0];
                    if (date < startDate || date > visualEndDate) { cell.classList.add('empty'); }
                    else {
                        cell.dataset.date = dateString;
                        cell.innerHTML = `<div class="calendar-day-number">${date.getDate()}</div>`;
                        const dayData = daysMap.get(dateString);
                        if (dayData) {
                            let contentHTML = '<ul>';
                            if (dayData.subjects && dayData.subjects.length > 0) {
                                const subjectTitles = dayData.subjects.map(subject => {
                                    const score = calculateSubjectScore(subject);
                                    const scoreText = score !== null ? `<span class="subject-score">(${score}%)</span>` : '';
                                    return `${subject}${scoreText}`;
                                }).join(' / ');
                                contentHTML += `<li><span class="subject-title">${subjectTitles}</span></li>`;
                            }
                            contentHTML += dayData.topics.map(topic => createTopicListItem(topic, dateString)).join('');
                            contentHTML += '</ul>';
                            cell.innerHTML += `<div class="day-content">${contentHTML}</div>`;
                        }
                    }
                    calendarContainer.appendChild(cell);
                });
            });
        }

        function updateGlobalProgressBars() {
            let completedTopics = 0;
            studyPlan.forEach(day => {
                day.topics.forEach(topic => {
                    const topicId = generateTopicId(day.date, topic);
                    if (isTopicComplete(topicId)) { completedTopics++; }
                });
            });
            const advancePercentage = totalTopics > 0 ? Math.round((completedTopics / totalTopics) * 100) : 0;
            globalAdvanceBar.style.width = `${advancePercentage}%`;
            globalAdvanceBar.textContent = `${advancePercentage}%`;
            let totalSubjectScoreSum = 0;
            let subjectsWithScoresCount = 0;
            const allSubjects = Array.from(subjectToTopicsMap.keys());
            allSubjects.forEach(subject => {
                const subjectScore = calculateSubjectScore(subject);
                if (subjectScore !== null) {
                    totalSubjectScoreSum += subjectScore;
                    subjectsWithScoresCount++;
                }
            });
            const scorePercentage = subjectsWithScoresCount > 0 ? Math.round(totalSubjectScoreSum / subjectsWithScoresCount) : 0;
            globalScoreBar.style.width = `${scorePercentage}%`;
            globalScoreBar.textContent = `${scorePercentage}%`;
        }

        function showDayModal(dateString) { const dayData = new Map(studyPlan.map(d => [d.date, d])).get(dateString); const date = new Date(dateString + "T00:00:00"); dayModalTitle.textContent = date.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' }); let topicsHTML = '<ul>'; if (dayData) { if (dayData.subjects && dayData.subjects.length > 0) { const subjectTitles = dayData.subjects.map(subject => { const score = calculateSubjectScore(subject); const scoreText = score !== null ? `<span class="subject-score">(${score}%)</span>` : ''; return `${subject}${scoreText}`; }).join(' / '); topicsHTML += `<li><span class="subject-title">${subjectTitles}</span></li>`; } topicsHTML += dayData.topics.map(topic => createTopicListItem(topic, dateString)).join(''); } topicsHTML += '</ul>'; dayModalTopicsContainer.innerHTML = topicsHTML; dayModalNotes.value = getData(`dayNotes.${dateString}`, ''); dayModal.dataset.currentDate = dateString; dayModalOverlay.classList.add('visible'); dayModal.classList.add('visible'); }
        function closeDayModal() { dayModalOverlay.classList.remove('visible'); dayModal.classList.remove('visible'); }
        function saveDayNote() { const dateString = dayModal.dataset.currentDate; if (dateString) { saveData(`dayNotes.${dateString}`, dayModalNotes.value); } closeDayModal(); }
        function showTopicPlan(topicId, topicName) { topicModal.dataset.currentTopicId = topicId; topicModalTitle.textContent = topicName; loadTopicState(topicId); topicModalOverlay.classList.add('visible'); topicModal.classList.add('visible'); }
        function closeTopicModal() { topicModalOverlay.classList.remove('visible'); topicModal.classList.remove('visible'); }
        function loadTopicState(topicId) { topicTaskCheckboxes.forEach(checkbox => { checkbox.checked = getData(`topicData.${topicId}.${checkbox.id}`) === true; }); aciertosInput.value = getData(`topicData.${topicId}.scoreAciertos`, ''); reactivosInput.value = getData(`topicData.${topicId}.scoreReactivos`, ''); updateScorePercentage(); updateAllStepCardsStatus(); }
        function saveTopicState(key, value) { const topicId = topicModal.dataset.currentTopicId; if (topicId) { saveData(`topicData.${topicId}.${key}`, value); } }
        function updateScorePercentage() { const aciertos = parseInt(aciertosInput.value) || 0; const reactivos = parseInt(reactivosInput.value) || 0; let percentage = 0; if (reactivos > 0) { percentage = Math.round((aciertos / reactivos) * 100); } const color = getScoreColor(percentage); percentageOutput.value = percentage + "%"; percentageOutput.style.color = color; }
        function updateStepCardStatus(cardElement) { const tasksInCard = cardElement.querySelectorAll('.task-checkbox'); const allTasksCompleted = Array.from(tasksInCard).every(task => task.checked); cardElement.classList.toggle('completed', allTasksCompleted); }
        function updateAllStepCardsStatus() { topicStepCards.forEach(updateStepCardStatus); }
        
        function finishTopicSession() {
            const topicId = topicModal.dataset.currentTopicId;
            if (!topicId) return;
            closeTopicModal();
            updateGlobalProgressBars();
            populateCalendar();
        }

        async function main() {
            displayDailyQuote();
            startCountdown();
            buildSubjectMap();
            const docRef = db.collection('userProgress').doc(currentUser.uid);
            const doc = await docRef.get();
            loadUserProgress(doc.exists ? doc.data() : null);
            populateCalendar();
            updateGlobalProgressBars();
            calendarContainer.addEventListener('click', e => { const cell = e.target.closest('.day-cell:not(.empty)'); if (cell) showDayModal(cell.dataset.date); });
            dayModalTopicsContainer.addEventListener('click', e => { const topicLi = e.target.closest('.topic-item'); if (topicLi) { const { topicId, topicName } = topicLi.dataset; showTopicPlan(topicId, topicName); } });
            dayModal.querySelector('#modal-close-day').addEventListener('click', closeDayModal); dayModalOverlay.addEventListener('click', closeDayModal);
            topicModal.querySelector('#modal-close-topic').addEventListener('click', closeTopicModal);
            finishTopicButton.addEventListener('click', finishTopicSession);
            document.addEventListener('keydown', e => { if (e.key === 'Escape') { if (topicModal.classList.contains('visible')) { closeTopicModal(); } else if (dayModal.classList.contains('visible')) { closeDayModal(); } } });
            saveNoteButton.addEventListener('click', saveDayNote);
            topicTaskCheckboxes.forEach(checkbox => { checkbox.addEventListener('change', function() { saveTopicState(this.id, this.checked); updateStepCardStatus(this.closest('.step-card')); }); });
            aciertosInput.addEventListener('input', () => { saveTopicState('scoreAciertos', aciertosInput.value); updateScorePercentage(); });
            reactivosInput.addEventListener('input', () => { saveTopicState('scoreReactivos', reactivosInput.value); updateScorePercentage(); });
        }

        main();
    }
    </script>
</body>
</html>
